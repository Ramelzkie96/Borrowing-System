{% extends "admin-base.html" %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">
<!-- Include Pickadate CSS from CDN -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pickadate.js/3.6.2/compressed/themes/default.css">
<link rel="stylesheet"
  href="https://cdnjs.cloudflare.com/ajax/libs/pickadate.js/3.6.2/compressed/themes/default.date.css">

<link rel="stylesheet"
  href="https://cdnjs.cloudflare.com/ajax/libs/tempusdominus-bootstrap-4/5.39.0/css/tempusdominus-bootstrap-4.min.css">

<style>
  .pagination-container {
    display: flex;
    justify-content: flex-end;
    margin-top: 20px;
    padding-right: 20px;
  }

  .pagination {
    margin-bottom: 0;
    font-size: 0.9rem;
  }

  .page-item.active .page-link {
    background-color: #007bff;
    border-color: #007bff;
    color: white;
  }

  .page-item .page-link {
    color: #007bff;
  }

  .page-link:hover {
    background-color: #f1f1f1;
  }

  .page-item.disabled .page-link {
    color: #6c757d;
  }

  .custom-modal .modal-dialog {
    overflow: hidden;
  }

  .custom-modal .modal-content {
    overflow: hidden;
  }

  .custom-modal .modal-body {
    overflow-y: auto;
    max-height: calc(100vh - 200px);
    /* Adjust this value as needed */
  }

  .error-border.form-control {
    border-color: red !important;
    border-width: 1px !important;
    /* Adjust as needed */
  }


  .input-group .form-control {
    padding-right: 3rem;
    /* Add padding to prevent overlap with button */
  }

  .input-group-append .btn {
    border-left: none;
    /* Optional: Remove border between input and button */
    padding: 0.3rem;
    /* Adjust padding for the button */
  }

  .input-group-append .btn i {
    font-size: 1rem;
    /* Adjust icon size if needed */
  }





  /* Styling for a smaller image preview container */
  .image-preview {
    width: 180px;
    /* Smaller width */
    height: 110px;
    /* Smaller height */
    border: 2px solid #ddd;
    border-radius: 10px;
    position: relative;
    display: flex;
    justify-content: center;
    align-items: center;
    overflow: hidden;
    background-color: #f7f7f7;
  }

  /* Hidden file input */
  #image-upload {
    display: none;
  }

  /* Style for the label that acts as the button */
  #image-label {
    position: absolute;
    width: 100%;
    height: 100%;

    color: #333;
    /* Default dark text */
    display: flex;
    justify-content: center;
    align-items: center;
    cursor: pointer;
    opacity: 1;
    transition: opacity 0.3s ease, color 0.3s ease;
    font-size: 14px;
    font-weight: bold;
  }

  /* Hover effect: show overlay and change text color to white */
  .image-preview:hover #image-label {
    opacity: 1;
    color: #2e7bff;
  }

  /* Style for the uploaded image */
  .image-preview img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: 10px;
  }
</style>

{% endblock %}


{% block extra_js %}
<!-- jQuery -->
<script src="{% static 'plugins/jquery/jquery.min.js' %}"></script>


<!-- Bootstrap -->
<script src="{% static 'plugins/bootstrap/js/bootstrap.bundle.min.js' %}"></script>
<!-- overlayScrollbars -->
<script src="{% static 'plugins/overlayScrollbars/js/jquery.overlayScrollbars.min.js' %}"></script>
<!-- AdminLTE App -->
<script src="{% static 'dist/js/adminlte.js' %}"></script>
<!-- PAGE PLUGINS -->
<!-- jQuery Mapael -->
<script src="{% static 'plugins/jquery-mousewheel/jquery.mousewheel.js' %}"></script>
<!-- AdminLTE dashboard demo (This is only for demo purposes) -->
<script src="dist/js/pages/dashboard2.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>



<script src="https://cdn.jsdelivr.net/npm/moment/min/moment.min.js"></script>
<script
  src="https://cdnjs.cloudflare.com/ajax/libs/tempusdominus-bootstrap-4/5.39.0/js/tempusdominus-bootstrap-4.min.js"></script>
<!-- date picker -->
<script>
  $(function () {
    $('#reservationdate').datetimepicker({
      format: 'D MMMM, YYYY' // Custom format: 1 November, 2024
    });

    // Optional: Open the date picker when the input is focused
    $('.datetimepicker-input').on('focus', function () {
      $(this).siblings('.input-group-append').click();
    });
  });


</script>




{% endblock %}



{% block content %}

<div class="wrapper">

  <!-- Preloader -->
  <div class="preloader flex-column justify-content-center align-items-center">
    <img class="animation__wobble" src="{% static 'dist/img/pit_logo.png' %}" alt="AdminLTELogo" height="60" width="60">
  </div>



  <!-- Main Sidebar Container -->
  <aside class="main-sidebar sidebar-dark-primary elevation-4">
    <!-- Brand Logo -->
    <a href="index3.html" class="brand-link">
      <img src="{% static 'dist/img/pit_logo.png' %}" alt="AdminLTE Logo" class="brand-image img-circle elevation-3"
        style="opacity: .8">
      <span class="brand-text font-weight-light">IT CHAIRMAN</span>
    </a>

    <!-- Sidebar -->
    <div class="sidebar">
      <!-- Sidebar user panel (optional) -->
      <div class="user-panel mt-3 pb-3 mb-3 d-flex">
        <div class="image">
          {% if request.user.profile_picture %}
          <img src="{{ request.user.profile_picture.url }}" class="img-circle elevation-2"
            alt="{{ request.user.username }}'s profile picture">
          {% else %}
          <img src="{% static 'images/users.jpg' %}" class="img-circle elevation-2" alt="Default profile picture">
          {% endif %}
        </div>
        <div class="info">
          <a href="{% url 'admin-dashboard' %}" class="d-block">{{ request.user.username }}</a>
        </div>
      </div>







      <!-- Sidebar Menu -->
      <nav class="mt-2">
        <ul class="nav nav-pills nav-sidebar flex-column" data-widget="treeview" role="menu" data-accordion="false">
          <li class="nav-header">Main Menu</li>
          <li class="nav-item">
            <a href="{% url 'admin-dashboard' %}" class="nav-link">
              <i class="nav-icon fas fa-tachometer-alt"></i>
              <p>
                Dashboard
              </p>
            </a>
          </li>
          <li class="nav-item">
            <a href="{% url 'admin-users' %}" class="nav-link">
              <i class="nav-icon fas fa-users"></i>
              <p>
                Users
              </p>
            </a>
          </li>
          <li class="nav-header">Items</li>
          <li class="nav-item">
            <a href="#" class="nav-link">
              <i class="nav-icon fas fa-box"></i>
              <p>
                Manage Items
                <i class="right fas fa-angle-left"></i>
              </p>
            </a>
            <ul class="nav nav-treeview">
              <li class="nav-item">
                <a href="{% url 'admin-add-item' %}" class="nav-link">
                  <i class="far fa-circle nav-icon"></i>
                  <p>Add Item</p>
                </a>
              </li>
              <li class="nav-item">
                <a href="{% url 'admin-item-record' %}" class="nav-link">
                  <i class="far fa-circle nav-icon"></i>
                  <p>Item Records</p>
                </a>
              </li>

            </ul>
          </li>
          <li class="nav-item "> <!--pang hover menu-open-->
            <a href="{% url 'admin-borrowers' %}" class="nav-link ">
              <i class="nav-icon fas fa-plus"></i>
              <p>
                Add Borrow Item
              </p>
            </a>
          </li>
          <li class="nav-item ">
            <a href="{% url 'admin-borrow-record' %}" class="nav-link active">
              <i class="nav-icon fas fa-clipboard"></i>
              <p>
                Borrowed Records
              </p>
            </a>
          </li>
          <li class="nav-item">
            <a href="{% url 'admin-returned-record' %}" class="nav-link">
              <i class="nav-icon fa-solid fa-arrow-rotate-left"></i>
              <p>
                Returned Records
              </p>
            </a>
          </li>

          <li class="nav-header">Borrowers Reservation</li>
          <li class="nav-item">
            <a href="{% url 'admin-student-reservation' %}" class="nav-link">
              <i class="nav-icon fas fa-list"></i>
              <p>
                Reservation List
              </p>
            </a>
          </li>


          <li class="nav-header">Accounts</li>
          <li class="nav-item">
            <a href="#" class="nav-link">
              <i class="nav-icon fas fa-users-gear"></i>
              <p>
                Manage accounts
                <i class="right fas fa-angle-left"></i>
              </p>
            </a>
            <ul class="nav nav-treeview">
              <li class="nav-item">
                <a href="{% url 'admin-change-profile' %}" class="nav-link">
                  <i class="far fa-circle nav-icon"></i>
                  <p>Change Profile</p>
                </a>
              </li>
              <li class="nav-item">
                <a href="{% url 'admin-change-password' %}" class="nav-link">
                  <i class="far fa-circle nav-icon"></i>
                  <p>Change Password</p>
                </a>
              </li>
            </ul>
          <li class="nav-item">
            <a href="{% url 'admin-logout' %}" class="nav-link">
              <i class="nav-icon fa-solid fa-right-from-bracket"></i>
              <p>
                Logout
              </p>
            </a>
          </li>

          </li>
        </ul>
      </nav>
      <!-- /.sidebar-menu -->
    </div>
    <!-- /.sidebar -->
  </aside>

  <!-- Content Wrapper. Contains page content -->
  <div class="content-wrapper">
    <!-- Content Header (Page header) -->

    <!-- /.content-header -->

    <!-- Main content -->
    <section class="content">
      <div class="container-fluid">

        <!-- /.row -->

        <div class="row">
          <div class="container-fluid">

            <div class="card mt-3" style="border-top: 4px solid #593bdb; box-shadow: rgba(0, 0, 0, 0.18) 0px 2px 4px;">
              <div class="card-header">
                <h4 class="card-title" style="font-size: 30px; font-weight: 700;">Edit Borrower Details</h4>
              </div>
              <div class="card-body">
                <div class="basic-form">


                  <form id="editBorrowerForm" method="post" action="{% url 'admin-save-borrower-update' %}">
                    {% csrf_token %}
                    <input type="hidden" name="id" value="{{ borrow_request_id }}">

                    <div class="form-row">
                      <div class="form-group col-md-6">
                        <label>Student ID</label>
                        <input type="text" name="student_id" class="form-control" value="{{ student_id }}">
                      </div>
                      <div class="form-group col-md-6">
                        <label>Name</label>
                        <input type="text" name="name" class="form-control" value="{{ name }}">
                      </div>
                      <div class="form-group col-md-6">
                        <label>Course</label>
                        <input type="text" name="course" class="form-control" value="{{ course }}">
                      </div>
                      <div class="form-group col-md-6">
                        <label>Year</label>
                        <select class="form-select form-control" name="year" style="border:1px solid rgba(0, 0, 0, 0.2);" aria-label="Default select example">
                          <option value="">----</option>
                          <option value="1st Year" {% if year == "1st Year" %}selected{% endif %}>1st Year</option>
                          <option value="2nd Year" {% if year == "2nd Year" %}selected{% endif %}>2nd Year</option>
                          <option value="3rd Year" {% if year == "3rd Year" %}selected{% endif %}>3rd Year</option>
                          <option value="4th Year" {% if year == "4th Year" %}selected{% endif %}>4th Year</option>
                      </select>
                      
                      
                      </div>
                    </div>

                    <div class="form-row">
                      <div class="form-group col-md-6">
                        <label>Email</label>
                        <input type="text" name="email" class="form-control" value="{{ email }}">
                      </div>
                      <div class="form-group col-md-3">
                        <label>Phone</label>
                        <input type="text" name="phone" class="form-control" value="{{ phone }}">
                      </div>
                      <div class="form-group col-md-3">
                        <label>Date Borrow</label>
                        <div class="input-with-icon">
                          <input name="datepicker" id="dateBorrow" class="datepicker-default form-control"
                            value="{{ date_borrow }}" style="border: 1px solid #bebebe; width: 180px;">
                          <i class="fas fa-calendar-alt" style="position: absolute; top: 38px; right: -50px;"></i>
                        </div>
                      </div>
                    </div>

                    <div class="form-row">
                      <div class="form-group col-md-2">
                        <label>
                          <input type="radio" name="borrower_type" value="Student" {% if borrower_type == "Student" %}checked{% endif %} id="student_radio" style="width: 20px; height: 20px;">&nbsp; Student
                        </label>
                      </div>
                      <div class="form-group col-md-2">
                        <label>
                          <input type="radio" name="borrower_type" value="Teacher" {% if borrower_type == "Teacher" %}checked{% endif %} id="teacher_radio" style="width: 20px; height: 20px;">&nbsp; Teacher
                        </label>
                      </div>
                      <div class="form-group col-md-2">
                        <label>
                          Others:
                          {% if borrower_type != "Student" and borrower_type != "Teacher" %}
                            <input type="text" name="other_borrower_type" id="other_borrower_type" value="{{ borrower_type }}" style="width: 100px; height: 20px;">
                          {% else %}
                            <input type="text" name="other_borrower_type" id="other_borrower_type" style="width: 100px; height: 20px;">
                          {% endif %}
                        </label>
                      </div>
                    </div>
                    
                    



                    <div class="form-row">
                      <div class="col-xl-6">

                        <div class="card">
                          <div class="col-xl-6">
                              <div class="card-body">
                                  <div class="mb-3">
                                      <h4 class="card-title">Item</h4>
                                  </div>
                                  {% if items %}
                                      <select name="itemm" id="itemSelect" class="form-control" aria-hidden="true" style="width: 300px;">
                                          
                                              {% for borrow_item in items %}
                                                  <option value="{{ borrow_item.item.id }}" 
                                                          data-available-quantity="{{ borrow_item.item.quantity }}" 
                                                          data-original-quantity="{{ borrow_item.quantityy }}">
                                                      {{ borrow_item.item.name }} (Available stock: {{ borrow_item.item.quantity }})
                                                  </option>
                                              {% endfor %}
                                      </select>

                                      <div class="mt-4">
                                          <label class="text-dark">Quantity</label>
                                          <input type="number" name="quantityy" id="quantityInput" class="form-control col-md-3" 
                                                 value="0" style="border: 1px solid #bebebe;">
                                          <span id="quantityError" class="text-danger" style="display: none;"></span>
                                          <!-- Error message area -->
                                      </div>
                                      {% else %}
                                          <input type="text" class="form-control" disabled value="mark as returned">
                                      {% endif %}
                                  
                      
                                  
                              </div>
                          </div>
                      </div>
                      
                      
                      
                      
                      


                      </div>
                      <div class="form-group col-md-6">
                        <label class="text-dark">Purpose for borrow</label>
                        <textarea name="description" class="form-control"
                          style="border: 1px solid #bebebe;">{{ purpose }}</textarea>
                      </div>
                    </div>


                    <div class="modal-footer">
                      <button type="button" class="btn btn-secondary" onclick="window.history.back();">Back</button>
                      <button type="submit" class="btn btn-primary" id="toastr-success-bottom-left">Update</button>
                    </div>
                  </form>


                </div>
              </div>

            </div>















          </div>
        </div>
        <!-- /.row -->


        <!-- /.row -->
      </div><!--/. container-fluid -->
    </section>
    <!-- /.content -->
  </div>
  <!-- /.content-wrapper -->

  <!-- Control Sidebar -->
  <aside class="control-sidebar control-sidebar-dark">
    <!-- Control sidebar content goes here -->
  </aside>
  <!-- /.control-sidebar -->

  <!-- Main Footer -->
  <!-- <footer class="main-footer">
      <strong>Copyright &copy; 2014-2021 <a href="https://adminlte.io">AdminLTE.io</a>.</strong>
      All rights reserved.
      <div class="float-right d-none d-sm-inline-block">
        <b>Version</b> 3.1.0
      </div>
    </footer> -->
</div>









<script>

  function checkOtherBorrowerType() {
    const otherInput = document.getElementById('other_borrower_type').value;

    if (otherInput) {
        // If there's input in the "Others" field, uncheck both radio buttons
        document.getElementById('student_radio').checked = false;
        document.getElementById('teacher_radio').checked = false;
    }
}

function clearOtherBorrowerType() {
    // Clear the "Others" input when either radio button is selected
    document.getElementById('other_borrower_type').value = '';
}




  $(document).ready(function () {
    // Function to update quantity input based on selected item
    function updateQuantityInput() {
        const selectedOption = $('#itemSelect option:selected');
        const originalQuantity = parseInt(selectedOption.data('original-quantity'));

        // Set the quantity input to the current quantity of the selected item
        $('#quantityInput').val(originalQuantity);
        $('#quantityError').hide(); // Hide any previous error message
    }

    // Call the update function on page load to set initial values
    updateQuantityInput();

    // Update quantity when a new item is selected
    $('#itemSelect').change(function () {
        updateQuantityInput();
    });

    // Real-time validation for quantity input
    $('#quantityInput').on('input', function () {
      const selectedOption = $('#itemSelect option:selected');
      const availableStock = parseInt(selectedOption.data('available-quantity'));
      const originalQuantity = parseInt(selectedOption.data('original-quantity'));
      let newQuantity = parseInt($(this).val());
  
      // Enforce minimum quantity of 1
      if (newQuantity < 1) {
          newQuantity = 1;
          $(this).val(newQuantity);
      }
  
      const additionalQuantity = newQuantity - originalQuantity;
      const errorMessage = $('#quantityError');
  
      // Show error message if the additional quantity exceeds available stock
      if (additionalQuantity > availableStock) {
          errorMessage.text('The requested additional quantity exceeds the available stock.').show();
      } else {
          errorMessage.hide(); // Hide error message if quantity is within limit
      }
  });
  

    // Handle form submission
    $('#editBorrowerForm').on('submit', function (e) {
        const selectedOption = $('#itemSelect option:selected');
        const availableStock = parseInt(selectedOption.data('available-quantity'));
        const originalQuantity = parseInt(selectedOption.data('original-quantity'));
        const newQuantity = parseInt($('#quantityInput').val());
        const additionalQuantity = newQuantity - originalQuantity;

        // Prevent form submission if additional quantity exceeds available stock
        if (additionalQuantity > availableStock) {
            e.preventDefault(); // Stop form submission
            $('#quantityError').text('Cannot submit: Additional quantity exceeds available stock.').show();
            return;
        }

        // Proceed with form submission if within stock
        e.preventDefault();
        $.ajax({
            type: 'POST',
            url: $(this).attr('action'),
            data: $(this).serialize(),
            success: function (response) {
                // Redirect to the borrow record page after success
                window.location.href = '/admin-borrow-record';
            },
            error: function (response) {
                console.log('Error:', response);
            }
        });
    });
});







</script>

{% endblock content %}