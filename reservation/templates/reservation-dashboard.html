{% extends "base.html" %}
{% load static %}

{% block extra_css %}
<!-- Google Font -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<!-- CSS -->
<link rel="stylesheet" type="text/css" href="{%static 'vendorss/styles/core.css'%}">
<link rel="stylesheet" type="text/css" href="{%static 'vendorss/styles/icon-font.min.css'%}">
<link rel="stylesheet" href="{% static 'vendor/select2/css/select2.min.css'%}">
<link rel="stylesheet" type="text/css" href="{%static 'vendorss/styles/style.css'%}">
<link rel="stylesheet" href="{% static 'vendor/pickadate/themes/default.css' %}">
<link rel="stylesheet" href="{% static 'vendor/pickadate/themes/default.date.css' %}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">
<style>
    /* Hide the alert after the transition */
    .hide-alert {
        opacity: 0;
        transition: opacity 0.6s ease-out;  /* Smooth transition */
    }

    /* Optional: smooth fade-in for when the alert first appears */
    .alert-fade {
        opacity: 1;
        transition: opacity 0.6s ease-in;  /* Smooth transition */
    }
    /* Adjust the size of the card container */
    .custom-card {
        height: 330px !important; /* Increase height */
        width: 1000px;  /* Increase width */
    }

    /* Optionally adjust the card styling */
    .card-box {
        height: 100%; /* Ensure the card-box fills its container */
        width: 100%;  /* Ensure the card-box fills its container */
        padding: 20px; /* Add padding if needed */
    }

    /* Style adjustments for elements inside the card */
    .card-box .reserve-img {
        width: 60px; /* Increase the icon size */
    }

    .card-box .h4 {
        font-size: 36px; /* Adjust font size for better visibility */
    }

    .card-box .font-14 {
        font-size: 18px; /* Adjust font size for better readability */
    }

    .card-box .btn {
        width: 180px; /* Increase button width */
        height: 40px; /* Increase button height */
        font-size: 14px; /* Increase button font size */
    }
    input[type="radio"] {
        appearance: none;
        -webkit-appearance: none;
        -moz-appearance: none;
        outline: none;
        background-color: transparent;
        border: 2px solid #bebebe;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        position: relative;
    }

    /* Style the radio button when it is checked */
    input[type="radio"]:checked::before {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        width: 12px;
        height: 12px;
        background-color: #007bff; /* Color of the checked state */
        border-radius: 50%;
        transform: translate(-50%, -50%);
    }

    /* Style the label to align with the custom radio button */
    label {
        display: flex;
        align-items: center;
        margin-bottom: 0;
        cursor: pointer;
    }

    /* Optional: Style the label when the radio button is focused */
    input[type="radio"]:focus + label {
        outline: 1px solid #007bff; /* Focus outline color */
    }
    .notification-close {
        background: none;
        border: none;
        color: #999; /* Adjust color as needed */
        font-size: 16px; /* Adjust size as needed */
        cursor: pointer;
        position: absolute;
        top: 10px; /* Adjust as needed */
        right: 10px; /* Adjust as needed */
    }

    .notification-close:hover {
        color: #f00; /* Change color on hover */
    }

    .notification-list {
        position: relative;
    }

    .notification-content {
        padding-right: 30px; /* Space for the close icon */
    }
    .dropdown-container {
        position: relative;
        display: inline-block;
        width: 100%;
    }

    .form-control {
        width: 100%;
        padding: 10px;
        box-sizing: border-box;
    }

    .dropdown-items {
        display: none; /* Hidden by default */
        position: absolute;
        background-color: white;
        max-height: 200px;
        overflow-y: auto;
        width: 100%;
        border: 1px solid #ddd;
        z-index: 1;
    }

    .dropdown-item {
        padding: 10px;
        cursor: pointer;
    }

    .dropdown-item:hover {
        background-color: #f1f1f1;
    }


    .plus-icon {
        position: absolute;
        top: 10px; /* Move the icon to the top */
        right: 10px; /* Keep it at the right edge */
        cursor: pointer;
        font-size: 1.5rem; /* Adjust font size for visibility */
        z-index: 10; /* Ensure the icon is above other content */
    }

    /* Media Query for smaller screens */
    @media (max-width: 576px) {
        .plus-icon {
            font-size: 1.2rem; /* Reduce font size on smaller screens */
            top: 5px; /* Adjust position for smaller screens */
            right: 5px; /* Adjust position for smaller screens */
        }
    }





</style>

{% endblock %}


{% block extra_js %}
<script src="{%static 'vendorss/scripts/core.js'%}"></script>
<script src="{%static 'vendorss/scripts/script.min.js'%}"></script>
<script src="{%static 'vendorss/scripts/process.js'%}"></script>
<script src="{%static 'vendorss/scripts/layout-settings.js'%}"></script>
<script src="{%static 'vendorss/scripts/dashboard.js'%}"></script>
<script src="{% static 'vendor/select2/js/select2.full.min.js'%}"></script>
<script src="{% static 'js/plugins-init/select2-init.js'%}"></script>
<!-- pickadate -->
<script src="{% static 'vendor/pickadate/picker.js' %}"></script>
<script src="{% static 'vendor/pickadate/picker.time.js' %}"></script>
<script src="{% static 'vendor/pickadate/picker.date.js' %}"></script>
<script src="{% static 'js/plugins-init/pickadate-init.js' %}"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
<script>
    function filterFunction() {
        let input = document.getElementById('searchInput');
        let filter = input.value.toLowerCase();
        let dropdown = document.getElementById('dropdownItems');
        let items = dropdown.getElementsByClassName('dropdown-item');

        for (let i = 0; i < items.length; i++) {
            let txtValue = items[i].textContent || items[i].innerText;
            if (txtValue.toLowerCase().indexOf(filter) > -1) {
                items[i].style.display = '';
            } else {
                items[i].style.display = 'none';
            }
        }
    }

    // Show the dropdown when focusing on the search input
    document.getElementById('searchInput').addEventListener('focus', function() {
        document.getElementById('dropdownItems').style.display = 'block';
    });

    // Close the dropdown when clicking outside
    document.addEventListener('click', function(e) {
        if (!e.target.matches('#searchInput') && !e.target.matches('.dropdown-item')) {
            document.getElementById('dropdownItems').style.display = 'none';
        }
    });

    // Handle item selection
    let dropdownItems = document.getElementsByClassName('dropdown-item');
    for (let i = 0; i < dropdownItems.length; i++) {
        dropdownItems[i].addEventListener('click', function() {
            let selectedValue = this.getAttribute('data-value');
            let selectedText = this.textContent;

            // Set the hidden input value
            document.getElementById('selectedItem').value = selectedValue;

            // Set the search input to the selected item
            document.getElementById('searchInput').value = selectedText;

            // Hide the dropdown
            document.getElementById('dropdownItems').style.display = 'none';
        });
    }

</script>
{% endblock %}



{% block content %}
<div class="header">
    <div class="header-left">
        <div class="menu-icon dw dw-menu"></div>
        <div class="header-search">
            <form>
                <div class="form-group mb-0">

                    <div class="dropdown">

                        <div class="dropdown-menu dropdown-menu-right">
                            <div class="form-group row">
                                <label class="col-sm-12 col-md-2 col-form-label">From</label>
                                <div class="col-sm-12 col-md-10">
                                    <input class="form-control form-control-sm form-control-line" type="text">
                                </div>
                            </div>
                            <div class="form-group row">
                                <label class="col-sm-12 col-md-2 col-form-label">To</label>
                                <div class="col-sm-12 col-md-10">
                                    <input class="form-control form-control-sm form-control-line" type="text">
                                </div>
                            </div>
                            <div class="form-group row">
                                <label class="col-sm-12 col-md-2 col-form-label">Subject</label>
                                <div class="col-sm-12 col-md-10">
                                    <input class="form-control form-control-sm form-control-line" type="text">
                                </div>
                            </div>
                            <div class="text-right">
                                <button class="btn btn-primary">Search</button>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
    <div class="header-right">
        <div class="dashboard-setting user-notification">
            <div class="dropdown">
                <a class="dropdown-toggle no-arrow" href="javascript:;" data-toggle="right-sidebar">
                    <i class="dw dw-settings2"></i>
                </a>
            </div>
        </div>


        <div class="user-notification">
            <div class="dropdown">
                <a class="dropdown-toggle no-arrow" href="#" role="button" data-toggle="dropdown">
                    <i class="icon-copy dw dw-notification"></i>
                    <span class="notification-active" style="font-size: 15px; font-weight: 800; position: absolute; color: red;" data-count="{{ reservation_items|length }}">
                        {{ reservation_items|length }}
                    </span>
                </a>
                <div class="dropdown-menu dropdown-menu-right">
                    <div class="notification-list mx-h-350 customscroll">
                        <ul>
                            {% for item in reservation_items %}
                            <li style="position: relative; padding-right: 30px;" data-id="{{ item.id }}">
                                <a href="#">
                                    <img src="{{ item.handled_by_profile_picture }}" alt="Profile Picture">
                                    <div class="notification-content">
                                        <h3>{{ item.user_type }}</h3>
                                        <p>{{ item.notification }}</p>
                                        <p>{{ item.time_ago }}</p>
                                    </div>
                                    <button class="notification-close" data-id="{{ item.id }}">
                                        <i class="icon-copy dw dw-delete-3"></i>
                                    </button>
                                </a>
                            </li>
                            {% empty %}
                            <li>No notifications</li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
            </div>
        </div>










        <div class="user-info-dropdown">
            <div class="dropdown">
                <a class="dropdown-toggle" href="#" role="button" data-toggle="dropdown">
                    <span class="user-icon" style="display: inline-block; width: 50px; height: 50px; overflow: hidden; border-radius: 50%;">
                        <img src="{{ user.profile_image.url }}" alt="Profile Image" style="width: 100%; height: 100%; object-fit: cover;">
                    </span>

                    <span class="user-name">{{ user.name }}</span>
                </a>
                <div class="dropdown-menu dropdown-menu-right dropdown-menu-icon-list">
                    <a class="dropdown-item" href="{% url 'reservation-change-profile' %}"><i class="dw dw-user1"></i>Edit Profile</a>
                    <a class="dropdown-item" href="{% url 'reservation-change-password' %}"><i class="dw dw-user1"></i>Change Password</a>
                    <a class="dropdown-item" href="{% url 'reservation-logout' %}"><i class="dw dw-logout"></i> Log Out</a>
                </div>
            </div>
        </div>

    </div>
</div>

<div class="right-sidebar">
    <div class="sidebar-title">
        <h3 class="weight-600 font-16 text-blue">
            Layout Settings
            <span class="btn-block font-weight-400 font-12">User Interface Settings</span>
        </h3>
        <div class="close-sidebar" data-toggle="right-sidebar-close">
            <i class="icon-copy ion-close-round"></i>
        </div>
    </div>
    <div class="right-sidebar-body customscroll">
        <div class="right-sidebar-body-content">
            <h4 class="weight-600 font-18 pb-10">Header Background</h4>
            <div class="sidebar-btn-group pb-30 mb-10">
                <a href="javascript:void(0);" class="btn btn-outline-primary header-white active">White</a>
                <a href="javascript:void(0);" class="btn btn-outline-primary header-dark">Dark</a>
            </div>

            <h4 class="weight-600 font-18 pb-10">Sidebar Background</h4>
            <div class="sidebar-btn-group pb-30 mb-10">
                <a href="javascript:void(0);" class="btn btn-outline-primary sidebar-light ">White</a>
                <a href="javascript:void(0);" class="btn btn-outline-primary sidebar-dark active">Dark</a>
            </div>

            <h4 class="weight-600 font-18 pb-10">Menu Dropdown Icon</h4>
            <div class="sidebar-radio-group pb-10 mb-10">
                <div class="custom-control custom-radio custom-control-inline">
                    <input type="radio" id="sidebaricon-1" name="menu-dropdown-icon" class="custom-control-input" value="icon-style-1" checked="">
                    <label class="custom-control-label" for="sidebaricon-1"><i class="fa fa-angle-down"></i></label>
                </div>
                <div class="custom-control custom-radio custom-control-inline">
                    <input type="radio" id="sidebaricon-2" name="menu-dropdown-icon" class="custom-control-input" value="icon-style-2">
                    <label class="custom-control-label" for="sidebaricon-2"><i class="ion-plus-round"></i></label>
                </div>
                <div class="custom-control custom-radio custom-control-inline">
                    <input type="radio" id="sidebaricon-3" name="menu-dropdown-icon" class="custom-control-input" value="icon-style-3">
                    <label class="custom-control-label" for="sidebaricon-3"><i class="fa fa-angle-double-right"></i></label>
                </div>
            </div>

            <h4 class="weight-600 font-18 pb-10">Menu List Icon</h4>
            <div class="sidebar-radio-group pb-30 mb-10">
                <div class="custom-control custom-radio custom-control-inline">
                    <input type="radio" id="sidebariconlist-1" name="menu-list-icon" class="custom-control-input" value="icon-list-style-1" checked="">
                    <label class="custom-control-label" for="sidebariconlist-1"><i class="ion-minus-round"></i></label>
                </div>
                <div class="custom-control custom-radio custom-control-inline">
                    <input type="radio" id="sidebariconlist-2" name="menu-list-icon" class="custom-control-input" value="icon-list-style-2">
                    <label class="custom-control-label" for="sidebariconlist-2"><i class="fa fa-circle-o" aria-hidden="true"></i></label>
                </div>
                <div class="custom-control custom-radio custom-control-inline">
                    <input type="radio" id="sidebariconlist-3" name="menu-list-icon" class="custom-control-input" value="icon-list-style-3">
                    <label class="custom-control-label" for="sidebariconlist-3"><i class="dw dw-check"></i></label>
                </div>
                <div class="custom-control custom-radio custom-control-inline">
                    <input type="radio" id="sidebariconlist-4" name="menu-list-icon" class="custom-control-input" value="icon-list-style-4" checked="">
                    <label class="custom-control-label" for="sidebariconlist-4"><i class="icon-copy dw dw-next-2"></i></label>
                </div>
                <div class="custom-control custom-radio custom-control-inline">
                    <input type="radio" id="sidebariconlist-5" name="menu-list-icon" class="custom-control-input" value="icon-list-style-5">
                    <label class="custom-control-label" for="sidebariconlist-5"><i class="dw dw-fast-forward-1"></i></label>
                </div>
                <div class="custom-control custom-radio custom-control-inline">
                    <input type="radio" id="sidebariconlist-6" name="menu-list-icon" class="custom-control-input" value="icon-list-style-6">
                    <label class="custom-control-label" for="sidebariconlist-6"><i class="dw dw-next"></i></label>
                </div>
            </div>

            <div class="reset-options pt-30 text-center">
                <button class="btn btn-danger" id="reset-settings">Reset Settings</button>
            </div>
        </div>
    </div>
</div>

<div class="left-side-bar">
    <div class="brand-logo">
        <a href="{% url 'reservation-dashboard' %}">
            <img src="{%static 'images/pit_logo.png'%}" alt="" width="50" height="50">
            <span class="text-white" style="font-weight: 800; font-size: 14px;">&nbsp; Student Reservation</span>
        </a>
        <div class="close-sidebar" data-toggle="left-sidebar-close">
            <i class="ion-close-round"></i>
        </div>
    </div>
    <div class="menu-block customscroll">
        <div class="sidebar-menu">
            <ul id="accordion-menu">
                <li>
                    <a href="javascript:void()" class="dropdown-toggle no-arrow">
                        <span class="micon fa-solid fa-gauge" style="font-size: 25px;"></span><span class="mtext">Home</span>
                    </a>
                </li>


                <li>
                    <a href="{% url 'reservation-status' %}" class="dropdown-toggle no-arrow">
                        <span class="micon fa-solid fa-spinner"></span><span class="mtext">Status</span>
                    </a>
                </li>

                <li>
                    <div class="dropdown-divider"></div>
                </li>

                <li class="dropdown">
                    <a href="javascript:;" class="dropdown-toggle">
                        <img src="{% static 'images/manage-account.png' %}" width="15" height="15" class="micon" alt=""><span class="mtext"> Manage Account </span>
                    </a>
                    <ul class="submenu">
                        <li><a href="{% url 'reservation-change-profile' %}">Edit Profile</a></li>
                        <li><a href="{% url 'reservation-change-password' %}">Change Password</a></li>
                    </ul>
                </li>
                <li>
                    <a href="{% url 'reservation-logout' %}" class="dropdown-toggle no-arrow">
                        <span class="micon fa-solid fa-right-from-bracket"></span><span class="mtext">Logout</span>
                    </a>
                </li>
            </ul>
        </div>
    </div>
</div>
<div class="mobile-menu-overlay"></div>




<div class="main-container">
    <!-- Dynamic messages start -->
    <div id="django-messages" style="display:none;">
        {% for message in messages %}
            <div class="message" data-type="{{ message.tags }}" data-content="{{ message|escapejs }}"></div>
        {% endfor %}
    </div>
    <!-- Dynamic messages end -->
    <div class="pd-ltr-20">
        <div class="card-box pd-20 height-100-p mb-30">
            <div class="row align-items-center">
                <div class="col-md-4">
                    <img src="{%static 'vendorss/images/banner-img.png'%}" alt="">
                </div>
                <div class="col-md-8">
                    <h4 class="font-20 weight-500 mb-10 text-capitalize">
                        Welcome to reservation item, <div class="weight-600 font-30 text-blue">{{ user.name }}!</div>
                    </h4>
                </div>
            </div>
        </div>
        <div class="card-box pd-20 height-100-p mb-30 custom-card">
            <div class="card-box height-100-p widget-style1">
                <div class="d-flex flex-column align-items-center justify-content-center h-100 text-center">
                    <div class="d-flex align-items-center mb-2">
                        <img class="reserve-img" src="{% static 'images/reserve-icon.png' %}" alt="" style="width: 60px; margin-right: 8px;"> <!-- Reserve icon before "350" -->
                        <div class="h4 mb-0">{{ total_reservations }}</div>
                    </div>
                    <div class="weight-600 font-14 mb-2">Total Reserve</div>
                    <button type="button" class="btn btn-outline-primary" data-toggle="modal" data-target="#reservationModal" style="width: 180px; height: 40px; font-size: 14px;">
                        Add Reservation
                    </button>
                </div>
            </div>
        </div>


        <div class="modal fade" id="reservationModal" tabindex="-1" role="dialog" aria-labelledby="reservationModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg" style="overflow: hidden;">
                <div class="modal-content">
                    <div class="modal-header" style="border-bottom: 2px solid #593bdb;">
                        <h2 class="modal-title" style="color: #593bdb;">Reservation Form</h2>
                        <button type="button" class="close" data-dismiss="modal"><span>&times;</span></button>
                    </div>
                    <div class="card-body">
                        <div class="basic-form">
                            <form id="editBorrowerForm" method="post" action="{% url 'submit_reservation' %}">
                                {% csrf_token %}
                                <input type="hidden" name="id" value="{{ user.id }}">
                                <div class="form-row">
                                    <div class="form-group col-md-6">
                                        <label class="text-dark">Student ID</label>
                                        <input type="text" name="student_id" class="form-control" value="{{ user.student_id }}" style="border: 1px solid #bebebe;">
                                    </div>
                                    <div class="form-group col-md-6">
                                        <label class="text-dark">Name</label>
                                        <input type="text" name="name" class="form-control" value="{{ user.name }}" style="border: 1px solid #bebebe;">
                                    </div>
                                    <div class="form-group col-md-6">
                                        <label class="text-dark">Course</label>
                                        <input type="text" name="course" value="{{ user.course }}" class="form-control" value="" style="border: 1px solid #bebebe;">
                                    </div>
                                    <div class="form-group col-md-6">
                                        <label class="text-dark">Year</label>
                                        <select class="form-select form-control" name="year" style="border:1px solid rgba(0, 0, 0, 0.2);" aria-label="Default select example" required>
                                            <option value="1st Year" {% if user.year_level == '1st Year' %}selected{% endif %}>1st Year</option>
                                            <option value="2nd Year" {% if user.year_level == '2nd Year' %}selected{% endif %}>2nd Year</option>
                                            <option value="3rd Year" {% if user.year_level == '3rd Year' %}selected{% endif %}>3rd Year</option>
                                            <option value="4th Year" {% if user.year_level == '4th Year' %}selected{% endif %}>4th Year</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group col-md-6">
                                        <label class="text-dark">Email</label>
                                        <input type="text" name="email" class="form-control" value="{{ user.email }}" style="border: 1px solid #bebebe;">
                                    </div>
                                    <div class="form-group col-md-3">
                                        <label class="text-dark">Phone</label>
                                        <input type="text" name="phone" class="form-control" value="{{ user.phone_number }}" style="border: 1px solid #bebebe;">
                                    </div>
                                    <div class="form-group col-md-3">
                                        <label class="text-dark">Date Reserve</label>
                                        <div class="input-with-icon">
                                            <input name="datepicker" id="dateBorrow" class="datepicker-default form-control" style="border: 1px solid #bebebe; background: white; font-size: 14px" required>
                                            <i class="fas fa-calendar-alt" style="position: absolute; top: 38px; right: -50px;"></i>
                                        </div>
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="col-xl-6">
                                        <div class="cardd mb-5" style="position: relative;">
                                            <!-- Plus Icon -->
                                            <div class="plus-icon" style="position: absolute; top: 10px; right: 10px; cursor: pointer;">
                                                <i class="fa fa-plus text-primary"></i>
                                            </div>

                                            <div class="card-bodyd">
                                                <div class="mt-4">
                                                    <h4 class="card-title">Items</h4>
                                                    <p>Select Item you want to borrow</p>
                                                    <select id="itemSelect" name="itemm" class="form-control" required>
                                                        <option value="">Select an item...</option>
                                                        <!-- Options will be populated here via JavaScript -->
                                                    </select>
                                                    <div class="text-danger mt-2"></div>
                                                </div>

                                                <div class="mt-4">
                                                    <label class="text-dark">Item Details (OPTIONAL) </label>
                                                    <textarea name="description" style="height: 50px; resize: vertical;" class="form-control" placeholder=""></textarea>
                                                </div>

                                                <div class="mt-4">
                                                    <label class="text-dark">Quantity</label>
                                                    <input type="number" name="quantityy" id="quantityy" class="form-control col-md-3" required style="border: 1px solid #bebebe;" value="1" >
                                                    <div class="text-danger mt-2"></div> <!-- Error message container -->
                                                </div>
                                            </div>
                                        </div>
                                    </div>




                                    <div class="form-group col-md-6">
                                        <label class="text-dark">Purpose</label>
                                        <textarea name="purpose" class="form-control" cols="1" rows="1" style="border: 1px solid #bebebe;"></textarea>
                                    </div>
                                </div>


                                <div class="modal-footer">
                                    <button type="button" class="btn btn-danger" data-dismiss="modal">Close</button>
                                    <button type="submit" class="btn btn-primary" onclick="validateForm()">Submit</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>




        <div class="footer-wrap pd-20 mb-20 card-box">
            Borrowing System By: <a href="https://github.com/dropways" target="_blank">Run Time Terror</a>
        </div>
    </div>
</div>



<!-- Add this script to hide the alerts after 5 seconds -->
<script>

    let itemQuantities = {}; // Object to store quantities of each item

function populateItems() {
    fetch('/get-faculty-items/') // Your actual endpoint to fetch items
        .then(response => response.json())
        .then(data => {
            const itemSelects = document.querySelectorAll('select[name="itemm"]');
            itemSelects.forEach(itemSelect => {
                // Clear existing options (except the default) only if the select is empty
                if (itemSelect.options.length === 1) {
                    data.forEach(item => {
                        const option = document.createElement('option');
                        option.value = item.id; // Set the item's ID as the value
                        option.textContent = `${item.name} (${item.quantity})`; // Set the display text
                        itemSelect.appendChild(option);
                        // Store the item's quantity for later validation
                        itemQuantities[item.id] = item.quantity;
                    });
                }
            });
        })
        .catch(error => console.error('Error fetching items:', error));
}

// Validate quantity based on selected item
function validateQuantity(selectElement, quantityInput) {
    const selectedItemId = selectElement.value;
    const availableQuantity = itemQuantities[selectedItemId] || 0; // Get available quantity

    const quantityValue = parseInt(quantityInput.value, 10);
    const quantityError = quantityInput.nextElementSibling; // Assumes error message is the next sibling
    const selectError = selectElement.nextElementSibling; // Assumes error message for select field is the next sibling

    // Clear previous error messages
    quantityError.textContent = '';
    selectError.textContent = '';

    // Show an error if quantity is 2 or more and no item is selected
    if (!selectedItemId && quantityValue >= 1) {
        quantityError.textContent = 'Please select an item before adding a quantity.';
    } else if (selectedItemId) {
        // If an item is selected, check if quantity exceeds available stock
        const availableQuantity = itemQuantities[selectedItemId] || 0; // Get available quantity
        if (quantityValue > availableQuantity) {
            quantityError.textContent = `You cannot borrow more than ${availableQuantity} of this item.`;
        }
    }

    // Validate uniqueness of selected item across cards
    const selectedItemIds = Array.from(document.querySelectorAll('select[name="itemm"]')).map(select => select.value);
    const duplicateItemId = selectedItemIds.find((id, index) => selectedItemIds.indexOf(id) !== index && id !== ''); // Check for duplicates

    if (duplicateItemId) {
        selectError.textContent = 'This item has already been selected in another card.';
    }

    updateSubmitButtonState(); // Check submit button state after validation
}


// Enable or disable the submit button based on validation
function updateSubmitButtonState() {
    const errorMessages = document.querySelectorAll('.text-danger'); // Select all error messages
    const submitButton = document.querySelector('button[type="submit"]');
    const hasErrors = Array.from(errorMessages).some(message => message.textContent.trim() !== '');

    submitButton.disabled = hasErrors; // Disable button if there are any error messages
}

// Event listener for select change
document.addEventListener('change', (event) => {
    if (event.target.matches('select[name="itemm"]')) {
        const selectElement = event.target;
        const quantityInput = selectElement.closest('.card-bodyd').querySelector('input[name="quantityy"]');
        validateQuantity(selectElement, quantityInput); // Validate on select change
    }
});

// Event listener for quantity input change
document.addEventListener('input', (event) => {
    if (event.target.matches('input[name="quantityy"]')) {
        const quantityInput = event.target;
        const selectElement = quantityInput.closest('.card-bodyd').querySelector('select[name="itemm"]');
        validateQuantity(selectElement, quantityInput); // Validate on quantity input change
    }
});


// Function to handle duplicating the col-xl-6 div
function duplicateCard(event) {
    const originalCol = event.target.closest('.col-xl-6');  // Find the closest col-xl-6 to the clicked plus icon
    if (!originalCol) return;  // Ensure there's a col-xl-6 to duplicate

    const newColDiv = originalCol.cloneNode(true);  // Clone the entire col-xl-6 div

    // Reset quantity input and clear error messages in the new card
    const quantityInput = newColDiv.querySelector('input[name="quantityy"]');
    if (quantityInput) {
        quantityInput.value = 1;  // Reset quantity
        quantityInput.nextElementSibling.textContent = '';  // Clear quantity error message
    }

    // Clear selected item in the new card and clear errors
    const selectElement = newColDiv.querySelector('select[name="itemm"]');
    if (selectElement) {
        selectElement.selectedIndex = 0;  // Reset to the default option
        selectElement.nextElementSibling.textContent = '';  // Clear select error message
    }

    // Clear the description field in the new card
    const descriptionInput = newColDiv.querySelector('textarea[name="description"]');
    if (descriptionInput) {
        descriptionInput.value = '';  // Clear the description field
    }

    // Add "X" icon for deleting the col-xl-6 div
    const closeIcon = document.createElement('div');
    closeIcon.innerHTML = '<i class="fa fa-times text-danger" style="cursor: pointer;"></i>';
    closeIcon.style.position = 'absolute';
    closeIcon.style.top = '10px';
    closeIcon.style.right = '10px';
    newColDiv.appendChild(closeIcon);
    closeIcon.addEventListener('click', () => newColDiv.remove());  // Remove the col-xl-6 div on click

    // Append the new col-xl-6 div to the container
    originalCol.closest('.form-row').appendChild(newColDiv);

    // Repopulate the items for the new card
    populateItems();

    // Reattach the event listener to the new plus icon in the duplicated col-xl-6
    const newPlusIcon = newColDiv.querySelector('.plus-icon');
    if (newPlusIcon) {
        newPlusIcon.addEventListener('click', duplicateCard);
    }
}

// Call this function when the document is loaded
document.addEventListener('DOMContentLoaded', () => {
    populateItems();  // Fetch and populate items on load

    // Attach event listener to all plus icons (both original and dynamically added)
    document.querySelectorAll('.plus-icon').forEach(plusIcon => {
        plusIcon.addEventListener('click', duplicateCard);  // Add event listeners to all plus icons
    });

    updateSubmitButtonState();  // Check the initial state of the submit button
});
















    document.addEventListener('DOMContentLoaded', function() {
        // Function to mark all notifications as read when the user opens the dropdown
        document.getElementById('notification-icon').addEventListener('click', function() {
            fetch('/mark-notifications-read/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({ 'action': 'mark_read' })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Mark all notifications as read
                    document.querySelectorAll('#notification-list li').forEach(function(li) {
                        li.classList.add('read');
                    });
                    // Optionally update the count of unread notifications
                    document.querySelector('.notification-active').textContent = '0';
                }
            })
            .catch(error => console.error('Error:', error));
        });

        // Function to close individual notifications
        document.querySelectorAll('.notification-close').forEach(button => {
            button.addEventListener('click', function() {
                const reservationId = this.getAttribute('data-id');

                fetch(`/mark-as-read/${reservationId}/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify({ 'reservation_id': reservationId })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        document.querySelector(`li[data-id="${reservationId}"]`).remove();
                    }
                });
            });
        });

        // CSRF token helper function
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    });




    document.addEventListener('DOMContentLoaded', function() {
        // Get all delete buttons
        const deleteButtons = document.querySelectorAll('.notification-close');
        const notificationCountElement = document.querySelector('.notification-active');

        deleteButtons.forEach(function(button) {
            button.addEventListener('click', function(e) {
                e.preventDefault();

                // Get the item id from the button's data-id attribute
                const itemId = this.getAttribute('data-id');

                // Send an AJAX request to delete the notification and reset is_handled to false
                fetch('/delete-notification/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'  // Ensure CSRF token is set
                    },
                    body: JSON.stringify({ 'item_id': itemId })  // Use 'item_id' here
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // If successful, remove the notification item from the list
                        const notificationItem = document.querySelector(`li[data-id="${itemId}"]`);
                        if (notificationItem) {
                            notificationItem.remove();  // Remove the entire notification
                        }

                        // Update the notification count in real time
                        let currentCount = parseInt(notificationCountElement.getAttribute('data-count'));
                        currentCount = currentCount > 0 ? currentCount - 1 : 0;
                        notificationCountElement.setAttribute('data-count', currentCount);
                        notificationCountElement.textContent = currentCount;
                    } else {
                        console.error('Error:', data.message || 'Failed to delete notification');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                });
            });
        });
    });













            //toaster message
document.addEventListener("DOMContentLoaded", function() {
    // Configure Toastr options
    toastr.options = {
        "closeButton": true,
        "progressBar": true,
        "timeOut": "5000",
        "positionClass": "toast-bottom-right"
    };

    // Loop through the hidden messages and display them
    document.querySelectorAll('#django-messages .message').forEach(function(el) {
        console.log(el);  // Add this for debugging
        var messageType = el.getAttribute('data-type');
        var messageContent = el.getAttribute('data-content');


        // Display Toastr notification based on the message type
        if (messageType === 'success') {
            toastr.success(messageContent);
        } else if (messageType === 'error') {
            toastr.error(messageContent);
        } else if (messageType === 'warning') {
            toastr.warning(messageContent);
        } else if (messageType === 'info') {
            toastr.info(messageContent);
        }
    });
});





</script>







{% endblock content %}