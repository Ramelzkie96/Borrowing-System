{% extends "base.html" %}
{% load static %}

{% block extra_css %}
    <link href="{% static 'vendor/pg-calendar/css/pignose.calendar.min.css'%}" rel="stylesheet">
    <link href="{% static 'vendor/chartist/css/chartist.min.css'%}" rel="stylesheet">
    <link href="{% static 'css/style.css'%}" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">
    <style>
        .activee {
            background: #6b51df;
        }
        .intp {
            padding-left: 45px;
            border: 1px solid #828282;
        }
        .intp::placeholder {
            padding-left: -10px;
        }

        .highlight {
            background-color: rgb(0, 255, 13);
        }

        
/* From Uiverse.io by vihstorck */ 
.switch {
    /* switch */
    --switch-width: 46px;
    --switch-height: 24px;
    --switch-bg: rgb(255, 47, 47);
    --switch-checked-bg: #1676df;
    --switch-offset: calc((var(--switch-height) - var(--circle-diameter)) / 2);
    --switch-transition: all 0.2s cubic-bezier(0.27, 0.2, 0.25, 1.51);
    /* circle */
    --circle-diameter: 18px;
    --circle-bg: #fff;
    --circle-shadow: 1px 1px 2px rgba(146, 146, 146, 0.45);
    --circle-checked-shadow: -1px 1px 2px rgba(163, 163, 163, 0.45);
    --circle-transition: var(--switch-transition);
    /* icon */
    --icon-transition: all 0.2s cubic-bezier(0.27, 0.2, 0.25, 1.51);
    --icon-cross-color: var(--switch-bg);
    --icon-cross-size: 6px;
    --icon-checkmark-color: var(--switch-checked-bg);
    --icon-checkmark-size: 10px;
    /* effect line */
    --effect-width: calc(var(--circle-diameter) / 2);
    --effect-height: calc(var(--effect-width) / 2 - 1px);
    --effect-bg: var(--circle-bg);
    --effect-border-radius: 1px;
    --effect-transition: all 0.2s ease-in-out;
  }
  
  .switch input {
    display: none;
  }
  
  .switch {
    display: inline-block;
  }
  
  .switch i {
    -webkit-transition: var(--icon-transition);
    -o-transition: var(--icon-transition);
    transition: var(--icon-transition);
    position: absolute;
    height: auto;
  }
  
  .switch .checkmark {
    width: var(--icon-checkmark-size);
    color: var(--icon-checkmark-color);
    -webkit-transform: scale(0);
    -ms-transform: scale(0);
    transform: scale(0);
  }
  
  .switch .cross {
    width: var(--icon-cross-size);
    color: var(--icon-cross-color);
  }
  
  .slider {
    -webkit-box-sizing: border-box;
    box-sizing: border-box;
    width: var(--switch-width);
    height: var(--switch-height);
    background: var(--switch-bg);
    border-radius: 999px;
    display: -webkit-box;
    display: -ms-flexbox;
    display: flex;
    -webkit-box-align: center;
    -ms-flex-align: center;
    align-items: center;
    position: relative;
    -webkit-transition: var(--switch-transition);
    -o-transition: var(--switch-transition);
    transition: var(--switch-transition);
    cursor: pointer;
  }
  
  .circle {
    width: var(--circle-diameter);
    height: var(--circle-diameter);
    background: var(--circle-bg);
    border-radius: inherit;
    -webkit-box-shadow: var(--circle-shadow);
    box-shadow: var(--circle-shadow);
    display: -webkit-box;
    display: -ms-flexbox;
    display: flex;
    -webkit-box-align: center;
    -ms-flex-align: center;
    align-items: center;
    -webkit-box-pack: center;
    -ms-flex-pack: center;
    justify-content: center;
    -webkit-transition: var(--circle-transition);
    -o-transition: var(--circle-transition);
    transition: var(--circle-transition);
    z-index: 1;
    position: absolute;
    left: var(--switch-offset);
  }
  
  .slider::before {
    content: "";
    position: absolute;
    width: var(--effect-width);
    height: var(--effect-height);
    left: calc(var(--switch-offset) + (var(--effect-width) / 2));
    background: var(--effect-bg);
    border-radius: var(--effect-border-radius);
    -webkit-transition: var(--effect-transition);
    -o-transition: var(--effect-transition);
    transition: var(--effect-transition);
  }
  
  /* actions */
  
  .switch input:checked + .slider {
    background: var(--switch-checked-bg);
  }
  
  .switch input:checked + .slider .checkmark {
    -webkit-transform: scale(1);
    -ms-transform: scale(1);
    transform: scale(1);
  }
  
  .switch input:checked + .slider .cross {
    -webkit-transform: scale(0);
    -ms-transform: scale(0);
    transform: scale(0);
  }
  
  .switch input:checked + .slider::before {
    left: calc(
      100% - var(--effect-width) - (var(--effect-width) / 2) -
        var(--switch-offset)
    );
  }
  
  .switch input:checked + .slider .circle {
    left: calc(100% - var(--circle-diameter) - var(--switch-offset));
    -webkit-box-shadow: var(--circle-checked-shadow);
    box-shadow: var(--circle-checked-shadow);
  }

  .nav {
    display: flex;
    justify-content: flex-end; /* Aligns items to the right */
    padding-right: 20px; /* Adds some spacing from the edge */
}

.bell-notification {
    position: relative;
    display: inline-block;
    cursor: pointer;
}

.bell-notification i {
    color: white;
    font-size: 20px;
    margin-right: 10px;
    cursor: pointer !important;
}

.notification-count {
    position: absolute;
    top: -12px;
    right: 12px !important;
    background-color: red;
    color: white;
    font-size: 12px;
    font-weight: bold;
    padding: 0.2px 4px !important;
    border-radius: 50%;
    border: 1px solid white;
    z-index: 1;
}

.notification-card {
  display: none;
  position: absolute;
  top: 50px;
  right: 90px;
  width: 600px; /* Increased width for better alignment */
  max-height: 300px; /* Set a maximum height for the card */
  overflow-y: auto; /* Enable vertical scrolling */
  background-color: white;
  border-radius: 8px;
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
  z-index: 10;
  padding: 10px;
}


.notification-card h4 {
  margin: 0;
  padding-bottom: 10px;
  border-bottom: 1px solid #ddd;
  font-size: 16px;
  color: #333;
}

.notification-item {
  margin: 10px 0;
  padding: 8px;
  border-bottom: 1px solid #ddd;
}

.notification-item:last-child {
  border-bottom: none;
}

.notification-item p {
  margin: 0;
  font-size: 14px;
  color: #555;
}

.notification-item strong {
  color: #000;
}

.trash-icon {
position: absolute;
top: 5px;
right: 5px;
cursor: pointer;
font-size: 8px;
color: red;
}


  
    </style>
{% endblock %}


{% block extra_js %}
    <script src="{% static 'vendor/global/global.min.js' %}"></script>
    <script src="{% static 'js/quixnav-init.js' %}"></script>
    <script src="{% static 'js/custom.min.js' %}"></script>
    <script src="{% static 'vendor/moment/moment.min.js'%}"></script>
    <script src="{% static 'js/dashboard/dashboard-2.js'%}"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
        <!-- SweetAlert2 CDN -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
{% endblock %}



{% block content %}
    <!--*******************
        Preloader start
    ********************-->
    <div id="preloader">
        <div class="sk-three-bounce">
            <div class="sk-child sk-bounce1"></div>
            <div class="sk-child sk-bounce2"></div>
            <div class="sk-child sk-bounce3"></div>
        </div>
    </div>
    <!--*******************
        Preloader end
    ********************-->


    <!--**********************************
        Main wrapper start
    ***********************************-->
    <div id="main-wrapper">

        <!--**********************************
            Nav header start
        ***********************************-->
        <div class="nav-header">
            <a href="index.html" class="brand-logo">
                <img class="logo-abbr" src="{% static 'images/pit_logo.png'%}" alt="">
                <img class="brand-title" src="{% static 'images/faculty.png'%}" alt="">
            </a>

            <div class="nav-control">
                <div class="hamburger">
                    <span class="line"></span><span class="line"></span><span class="line"></span>
                </div>
            </div>
        </div>
        <!--**********************************
            Nav header end
        ***********************************-->

        <!--**********************************
            Header start
        ***********************************-->
        <div class="header">
            <div class="header-content">
                <nav class="navbar navbar-expand">
                    <div class="collapse navbar-collapse justify-content-between">
                        <div class="header-left">

                        </div>

                        <ul class="navbar-nav header-right">

                            <li class="nav-item" bell-notification" onclick="toggleNotifications()">
                                <i class="fa-solid fa-bell" style="padding-right: 1px; font-size: 23px; cursor: pointer !important;"></i>
                                <span class="notification-count" style="position: relative; right: 23px;">0</span>
                                <div class="notification-card" id="notificationCard" style="display: none;">
                                    <h4>Notifications</h4>
                                </div>
                            </li>

                            <li class="nav-item dropdown header-profile">
                                <a class="nav-link" href="#" role="button" data-toggle="dropdown">
                                    <a class="nav-link" href="#" role="button" data-toggle="dropdown">
                                        {% if request.user.profile_picture %}
                                            <img src="{{ request.user.profile_picture.url }}" alt="{{ request.user.username }}'s profile picture">
                                        {% else %}
                                        <img src="{% static 'images/users.jpg' %}" alt="Default profile picture">
                                        {% endif %}
                                    </a>
                                    <span class="text-dark">{{ request.user.username }}</span>
                                </a>
                                <div class="dropdown-menu dropdown-menu-right">
                                    <a href="./app-profile.html" class="dropdown-item">
                                        <i class="icon-user"></i>
                                        <span class="ml-2">Profile </span>
                                    </a>
                                    <a href="./email-inbox.html" class="dropdown-item">
                                        <i class="icon-envelope-open"></i>
                                        <span class="ml-2">Inbox </span>
                                    </a>
                                    <a href="./page-login.html" class="dropdown-item">
                                        <i class="icon-key"></i>
                                        <span class="ml-2">Logout </span>
                                    </a>
                                </div>
                            </li>
                        </ul>
                    </div>
                </nav>
            </div>
        </div>
        <!--**********************************
            Header end ti-comment-alt
        ***********************************-->

        <!--**********************************
            Sidebar start
        ***********************************-->
        <div class="quixnav">
            <div class="quixnav-scroll">
                <ul class="metismenu" id="menu">
                    <li class="nav-label first">Main Menu</li>
                    <!-- <li><a href="index.html"><i class="icon icon-single-04"></i><span class="nav-text">Dashboard</span></a>
                    </li> -->
                    <li><a  href="{% url 'dashboard'%}" aria-expanded="false">
                        <img src="{% static 'images/dashboard.png'%}" width="30" height="30" alt="">
                        <span class="nav-text">Dashboard</span></a>

                    </li>

                    <li class="nav-label">ITEMS</li>
                    <li><a class="activee has-arrow" href="javascript:void()" aria-expanded="false">
                        <img src="{% static 'images/item.png'%}" width="30" height="30" alt="">
                        <span class="nav-text" >Manage Items</span></a>
                        <ul aria-expanded="false">
                            <li><a href="{%url 'add-item'%}">Add Item</a></li>
                            <li><a href="{% url 'item-record'%}" style="color: white;">Item Records</a></li>
                        </ul>
                    </li>
                    <li><a href="{% url 'borrowers'%}" aria-expanded="false">
                        <img src="{% static 'images/add-item.png'%}" width="30" height="30" alt="">
                        <span class="nav-text">Add Borrow Item</span></a>
                    </li>
                    <li><a href="{% url 'borrow-record'%}" aria-expanded="false">
                        <img src="{% static 'images/search.png'%}" width="30" height="30" alt="">
                        <span class="nav-text">Borrow Record</span></a>
                    </li>

                    <li class="nav-label">Borrower's Reservation</li>
                    <li><a  href="{% url 'student-reservation' %}" aria-expanded="false">
                        <img src="{% static 'images/reservation.png'%}" width="30" height="30" alt="">
                        <span class="nav-text">Reservation List</span></a>
                    </li>

                    <li class="nav-label">ACCOUNTS</li>
                    <li><a class="has-arrow" href="javascript:void()" aria-expanded="false">
                        <img src="{% static 'images/userr.png'%}" width="30" height="30" alt="">
                        <span class="nav-text">User</span></a>
                        <ul aria-expanded="false">
                            <li><a href="{% url 'change-profile' %}">Change Profile</a></li>
                            <li><a href="{% url 'change-password' %}">Change Password</a></li>
                        </ul>
                    </li>
                    <li><a href="{% url 'logout'%}" aria-expanded="false">
                        <img src="{% static 'images/logout.png'%}" width="30" height="30" alt="">
                        <span class="nav-text">Logout</span></a>
                    </li>
                </ul>
            </div>
        </div>
        <!--**********************************
            Sidebar end
        ***********************************-->

        <!--**********************************
            Content body start
        ***********************************-->

        <!-- Modal for Editing Item -->
<div class="modal fade" id="exampleModalCenter">
    <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" style="font-size: 25px; font-weight: 700;">Edit Item</h5>
                <button type="button" class="close" data-dismiss="modal"><span>&times;</span></button>
            </div>
            <div class="modal-body">
              <form action="{% url 'update-property-status' %}" method="POST">
                {% csrf_token %}
                
                <!-- Input for Item Name -->
                <div class="row mb-3">
                    <div class="col-4 ">
                        <label for="itemName" class="text-dark">Item Name</label>
                        <input type="text" id="itemName" name="item_name" class="form-control text-dark" style="border: 1px solid #bebebe;">
                    </div>
                    <div class="col-4 ">
                        <label for="totalQuantity" class="text-dark">Total Quantity</label>
                        <input type="number" id="totalQuantity" name="total_quantity" class="form-control text-dark" style="border: 1px solid #bebebe;">
                    </div>
                    <div class="col-4 ">
                        <input type="hidden" id="quantity" name="quantity" class="form-control text-dark" style="border: 1px solid #bebebe;">
                    </div>
                </div>
            
                <table class="table table-bordered" style="table-layout: fixed; width: 100%;">
                    <thead class="thead-dark">
                        <tr>
                            <th style="width: 33%;">Property ID</th>
                            <th style="width: 33%;">Status</th>
                            <th style="width: 33%;">Condition (Good/Defective)</th>
                        </tr>
                    </thead>
                    <tbody id="modalTableBody">
                        <!-- Dynamic rows will be added here based on the selected item -->
                    </tbody>
                </table>
            
                <div class="modal-footer">
                    <div class="mr-auto" style="font-size: 14px; color: #888;">
                        <small>Note: You can edit the Property ID by clicking on the corresponding value in the table.</small>
                    </div>
                    <button type="submit" name="submit" class="btn btn-secondary">Save</button>
                </div>
            </form>
            
          
            
            
            </div>
        </div>
    </div>
  </div>


        <div class="content-body">

            <!-- Dynamic messages start -->
            <div id="django-messages" style="display:none;">
                {% for message in messages %}
                    <div class="message" data-type="{{ message.tags }}" data-content="{{ message|escapejs }}"></div>
                {% endfor %}
            </div>
            <!-- Dynamic messages end -->

            <div class="container-fluid">
                <div class="row">
                    <div class="col-lg-12">
                        <div class="card" style="border-top: 4px solid #593bdb; box-shadow: rgba(0, 0, 0, 0.18) 0px 2px 4px;">
                            <div class="card-header">
                                <h4 class="card-title" style="font-size: 25px;color: #593bdb;">All Item</h4>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <div style="display: flex; justify-content: space-between;">
                                        <a href="{% url 'add-item' %}" class="btn btn-whatsapp mb-3" style="box-shadow: rgba(0, 0, 0, 0.24) 0px 3px 8px;"><img src="{% static 'images/plus.png' %}" alt="" width="30" height="30"> Add New Item </a>
                                        <div class="sea">
                                            <i class='bx bx-search-alt-2' style="color: #593bdb; position: absolute; font-size: 20px; right: 200px; top: 83px;"></i>
                                            <input type="search" id="searchInput" placeholder="Search" class="form-control intp" onkeyup="searchTable()">
                                        </div>
                                    </div>
                                    <div class="dataTables_length" id="example_length" style="color: #333; width: 140px;">
                                        <label>Show entries
                                            <select name="example_length" aria-controls="example" class="form-control" onchange="updateShowEntries(this.value)">
                                                <option value="all" {% if current_show == 'all' %}selected{% endif %}>All</option>
                                                <option value="5" {% if current_show == 5 %}selected{% endif %}>5</option>
                                                <option value="10" {% if current_show == 10 %}selected{% endif %}>10</option>
                                                <option value="25" {% if current_show == 25 %}selected{% endif %}>25</option>
                                                <option value="50" {% if current_show == 50 %}selected{% endif %}>50</option>
                                                <option value="100" {% if current_show == 100 %}selected{% endif %}>100</option>
                                            </select>
                                        </label>
                                    </div>

                                    <table id="itemTable" class="table table-bordered table-striped table-responsive-sm" style="color: #333;">
                                        <thead class="thead-primary">
                                            <tr>
                                               
                                                <th>Item</th>
                                                <th>Total Quantity</th>
                                                <th>Available Quantity</th>
                                                <th style="width: 150px;">Action</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% if page_obj %}
                                                {% for item in page_obj %}
                                                    <tr>
                                                       
                                                        <td>{{ item.name }}</td>
                                                        <td>{{ item.total_quantity }}</td>
                                                        <td>{{ item.quantity }}</td>
                                                        <td>
                                                            <button type="button" class="btn btn-secondary edit-item-btn" 
                                                                    data-id="{{ item.id }}" 
                                                                    data-name="{{ item.name }}" 
                                                                    data-totalquantity="{{ item.total_quantity }}" 
                                                                    data-quantity="{{ item.quantity }}" 
                                                                    data-toggle="modal" 
                                                                    data-target="#exampleModalCenter">
                                                                <i class="fas fa-edit"></i>
                                                            </button>

                                                            <button class="btn btn-danger btn deleteButton" data-item-id="{{ item.id }}"><i class="fas fa-trash"></i></button>
                                                        </td>
                                                    </tr>
                                                {% endfor %}
                                            {% else %}
                                                <tr>
                                                    <td colspan="5" class="text-center">No Record Available</td>
                                                </tr>
                                            {% endif %}
                                        </tbody>
                                    </table>


                                    <nav>
                                        <ul class="pagination pagination-gutter">
                                            {% if page_obj.has_previous %}
                                                <li class="page-item page-indicator">
                                                    <a class="page-link" href="?page={{ page_obj.previous_page_number }}&show={{ current_show }}">
                                                        <i class="icon-arrow-left"></i>
                                                    </a>
                                                </li>
                                            {% else %}
                                                <li class="page-item page-indicator disabled">
                                                    <a class="page-link" href="javascript:void(0)">
                                                        <i class="icon-arrow-left"></i>
                                                    </a>
                                                </li>
                                            {% endif %}
                                            {% for num in page_obj.paginator.page_range %}
                                                {% if page_obj.number == num %}
                                                    <li class="page-item active">
                                                        <a class="page-link" href="javascript:void(0)">{{ num }}</a>
                                                    </li>
                                                {% else %}
                                                    <li class="page-item">
                                                        <a class="page-link" href="?page={{ num }}&show={{ current_show }}">{{ num }}</a>
                                                    </li>
                                                {% endif %}
                                            {% endfor %}
                                            {% if page_obj.has_next %}
                                                <li class="page-item page-indicator">
                                                    <a class="page-link" href="?page={{ page_obj.next_page_number }}&show={{ current_show }}">
                                                        <i class="icon-arrow-right"></i>
                                                    </a>
                                                </li>
                                            {% else %}
                                                <li class="page-item page-indicator disabled">
                                                    <a class="page-link" href="javascript:void(0)">
                                                        <i class="icon-arrow-right"></i>
                                                    </a>
                                                </li>
                                            {% endif %}
                                        </ul>
                                    </nav>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
        <!--**********************************
            Content body end
        ***********************************-->


        <!--**********************************
            Footer start
        ***********************************-->
        <div class="footer">
            <div class="copyright">
                <p>Copyright Â© Designed &amp; Developed by <a href="#" target="_blank">Quixkit</a> 2019</p>
                <p>Distributed by <a href="https://themewagon.com/" target="_blank">Themewagon</a></p>
            </div>
        </div>
    </div>


    <script>
        document.querySelectorAll('.edit-item-btn').forEach(button => {
            button.addEventListener('click', function () {
                const itemId = this.getAttribute('data-id');
                const itemName = this.getAttribute('data-name');
                const initialTotalQuantity = parseInt(this.getAttribute('data-totalquantity'));
                const initialQuantity = parseInt(this.getAttribute('data-quantity'));
        
                // Set the item name and initial values in the input fields
                document.getElementById('itemName').value = itemName;
                const totalQuantityField = document.getElementById('totalQuantity');
                const quantityField = document.getElementById('quantity');
                totalQuantityField.value = initialTotalQuantity;
                quantityField.value = initialQuantity;
        
                // Set the minimum value for totalQuantityField
                totalQuantityField.min = initialTotalQuantity;
        
                // Initialize original total quantity
                let originalTotalQuantity = initialTotalQuantity;
        
                // Track the dynamically added rows
                let dynamicRows = [];
        
                // Update rows dynamically in real-time based on the input value
                totalQuantityField.addEventListener('input', function () {
                    const newTotalQuantity = this.value.trim() === '' ? '' : parseInt(this.value);
        
                    if (newTotalQuantity === '' || !isNaN(newTotalQuantity)) {
                        const modalTableBody = document.getElementById('modalTableBody');
                        const currentRowCount = modalTableBody.rows.length;
        
                        if (newTotalQuantity > currentRowCount) {
                            // Add rows for increased quantity
                            const difference = newTotalQuantity - currentRowCount;
                            for (let i = 0; i < difference; i++) {
                                const row = document.createElement('tr');
                                row.innerHTML = 
                                    `<td style="text-align: center; vertical-align: middle;">
                                        <input type="text" required placeholder="Type here the new property ID" 
                                               class="property-id-input" 
                                               style="text-align: center; border: none; background: transparent; width: 100%;" />
                                    </td>
                                    <td style="text-align: center; vertical-align: middle;">
                                        <span class="badge badge-success status-badge">Good</span>
                                    </td>
                                    <td style="text-align: center; vertical-align: middle;">
                                        <label class="switch">
                                            <input type="checkbox" checked class="status-toggle" />
                                            <div class="slider">
                                                <div class="circle">
                                                    <i class="fa-solid fa-x cross" style="font-size:9px;"></i>
                                                    <i class="fa-solid fa-check checkmark" style="font-size: 11px;"></i>
                                                </div>
                                            </div>
                                        </label>
                                    </td>
                                `;
                                modalTableBody.appendChild(row);
                                dynamicRows.push(row);  // Track dynamic rows
                            }
                        } else if (newTotalQuantity < currentRowCount) {
                            // Remove only dynamically added rows for decreased quantity
                            const difference = currentRowCount - newTotalQuantity;
                            for (let i = 0; i < difference; i++) {
                                const rowToRemove = dynamicRows.pop();  // Remove from dynamic rows
                                if (rowToRemove) {
                                    modalTableBody.removeChild(rowToRemove);
                                }
                            }
                        }
        
                        // Update the original total quantity if it's a valid number
                        originalTotalQuantity = newTotalQuantity;
                    } else {
                        alert('Invalid total quantity value!');
                        this.value = originalTotalQuantity;
                    }
                });
        
                // Fetch property IDs and populate the table
                fetch(`/get_property_ids/${itemId}/`)
                    .then(response => response.json())
                    .then(data => {
                        const modalTableBody = document.getElementById('modalTableBody');
                        modalTableBody.innerHTML = '';  // Clear all rows initially
        
                        // Add static rows based on property IDs
                        data.property_ids.forEach(property => {
                            const row = document.createElement('tr');
                            row.setAttribute('data-property-id', property.property_id);
        
                            row.innerHTML = 
                                `<td style="text-align: center; vertical-align: middle;">
                                    <input type="text" value="${property.property_id}" 
                                           class="property-id-input" 
                                           data-original-id="${property.property_id}" 
                                           style="text-align: center; border: none; background: transparent; width: 100%;" />
                                </td>
                                <td style="text-align: center; vertical-align: middle;">
                                    <span class="badge ${property.status === 'Good' ? 'badge-success' : 'badge-secondary'} status-badge">
                                        ${property.status}
                                    </span>
                                </td>
                                <td style="text-align: center; vertical-align: middle;">
                                    <label class="switch">
                                        <input type="checkbox" ${property.status === 'Good' ? 'checked' : ''} 
                                               data-id="${property.property_id}" 
                                               class="status-toggle" />
                                        <div class="slider">
                                            <div class="circle">
                                                <i class="fa-solid fa-x cross" style="font-size:9px;"></i>
                                                <i class="fa-solid fa-check checkmark" style="font-size: 11px;"></i>
                                            </div>
                                        </div>
                                    </label>
                                </td>
                            `;
                            modalTableBody.appendChild(row);
                        });
        
                        // Attach event listener to status toggles
                        document.querySelectorAll('.status-toggle').forEach(checkbox => {
                            checkbox.addEventListener('change', function () {
                                const propertyId = this.getAttribute('data-id');
                                const newStatus = this.checked ? 'Good' : 'Defective';
        
                                const statusBadge = this.closest('tr').querySelector('.status-badge');
                                statusBadge.textContent = newStatus;
                                statusBadge.className = `badge ${newStatus === 'Good' ? 'badge-success' : 'badge-secondary'} status-badge`;
                            });
                        });
                    })
                    .catch(error => {
                        console.error('Error fetching property IDs:', error);
                    });
            });
        });
        
        
        
        
      // When form is submitted, check the selected checkboxes and set status to "Defective" or "Good"
      document.querySelector('form').addEventListener('submit', function (event) {
        const rows = document.querySelectorAll('#modalTableBody tr');
        const newItems = [];
        const propertyIds = new Set();
        let hasDuplicate = false; // Flag to track duplicate detection
    
        rows.forEach(row => {
            const propertyIdInput = row.querySelector('.property-id-input');
            const updatedPropertyId = propertyIdInput.value;
            const originalPropertyId = propertyIdInput.getAttribute('data-original-id');
            const checkbox = row.querySelector('.status-toggle');
            const status = checkbox.checked ? 'Good' : 'Defective';
    
            if (!originalPropertyId) {
                // Newly added rows (no `data-original-id`)
                newItems.push({
                    property_id: updatedPropertyId,
                    status: status,
                });
            } else {
                // Handle updates for existing rows
                if (propertyIds.has(updatedPropertyId)) {
                    hasDuplicate = true;
                    alert(`Duplicate Property ID found: ${updatedPropertyId}`);
                    return; // Exit the loop
                } else {
                    propertyIds.add(updatedPropertyId);
                }
    
                const hiddenInput = document.createElement('input');
                hiddenInput.type = 'hidden';
                hiddenInput.name = 'property_updates[]';
                hiddenInput.value = `${originalPropertyId},${updatedPropertyId},${status}`;
                row.appendChild(hiddenInput);
            }
        });
    
        if (hasDuplicate) {
            event.preventDefault();
            return; // Prevent submission if duplicates exist
        }
    
        // Add new items to a hidden field
        const newItemsInput = document.createElement('input');
        newItemsInput.type = 'hidden';
        newItemsInput.name = 'new_items';
        newItemsInput.value = JSON.stringify(newItems);
        this.appendChild(newItemsInput);
    });
    
    
    






  document.addEventListener('DOMContentLoaded', function () {
    const totalQuantityField = document.querySelector('input[name="total_quantity"]');
    const availableQuantityField = document.querySelector('input[name="quantity"]');
    const submitButton = document.getElementById('submit-button');
    
    function validateQuantities() {
        const totalQuantity = parseInt(totalQuantityField.value, 10);
        const availableQuantity = parseInt(availableQuantityField.value, 10);
        const errorDiv = document.getElementById('quantity-validation-error');

        if (!isNaN(totalQuantity) && !isNaN(availableQuantity)) {
            if (availableQuantity > totalQuantity) {
                errorDiv.style.display = 'block';
                errorDiv.textContent = 'Available quantity cannot exceed the total quantity.';
                submitButton.disabled = true;
            } else {
                errorDiv.style.display = 'none';
                submitButton.disabled = false;
            }
        } else {
            errorDiv.style.display = 'none';
            submitButton.disabled = false;
        }
    }

    totalQuantityField.addEventListener('input', validateQuantities);
    availableQuantityField.addEventListener('input', validateQuantities);
});






        function updateShowEntries(value) {
    const urlParams = new URLSearchParams(window.location.search);
    urlParams.set('show', value);
    window.location.search = urlParams.toString();
}




document.getElementById("searchInput").addEventListener("input", function () {
    searchTable();
  });
  
  function searchTable() {
    var input, filter, table, tbody, tr, td, i, j, txtValue, regex;
    input = document.getElementById("searchInput");
    filter = input.value.toUpperCase();
    regex = new RegExp(`(${filter})`, 'gi');
    table = document.getElementById("itemTable");
    tbody = table.getElementsByTagName("tbody")[0]; // Work only with tbody
    tr = tbody.getElementsByTagName("tr"); // Get rows only from tbody
    var noMatch = true;
  
    // If the input is empty, reset table to show all rows and ensure "No record found" row is removed
    if (!filter) {
      for (i = 0; i < tr.length; i++) {
        if (tr[i].classList.contains("no-record-row")) continue; // Skip the "No record found" row
        tr[i].style.display = ""; // Show all rows
        td = tr[i].getElementsByTagName("td");
        for (j = 0; j < td.length; j++) {
          // Ensure buttons, dropdowns, badges, and action columns are not affected
          if (j === 4 || td[j].querySelector('.dropdownnn') || td[j].querySelector('.badge') || td[j].querySelector('.action-buttons')) {
            continue; // Skip "Status", "Action", and dropdowns, badges
          }
          td[j].innerHTML = td[j].textContent || td[j].innerText; // Reset text content
        }
      }
      removeNoRecordRow(); // Remove "No record found" if it exists
      return; // Exit function if input is empty
    }
  
    // If there's input, filter the table rows
    noMatch = true; // Reset noMatch for the filtering
    for (i = 0; i < tr.length; i++) {
      if (tr[i].classList.contains("no-record-row")) continue; // Skip "No record found" row
  
      tr[i].style.display = "none"; // Hide all rows initially
      td = tr[i].getElementsByTagName("td");
      let rowContainsFilter = false;
  
      // Iterate through each cell in the row
      for (j = 0; j < td.length; j++) {
        if (j === 4) continue; // Skip "Status" and "Action" columns
        if (td[j]) {
          txtValue = td[j].textContent || td[j].innerText;
          if (txtValue.toUpperCase().indexOf(filter) > -1) {
            rowContainsFilter = true;
            // Highlight matched text only in non-dropdown cells
            if (!td[j].querySelector('.dropdown')) {
              td[j].innerHTML = txtValue.replace(regex, "<span style='background-color: #3f6791; color: white;'>$1</span>");
            }
          } else {
            // Remove highlights if no match
            if (!td[j].querySelector('.dropdown')) {
              td[j].innerHTML = txtValue.replace(/<span style='background-color:.*?'>(.*?)<\/span>/g, "$1");
            }
          }
        }
      }
  
      // If the row contains the filter, show it
      if (rowContainsFilter) {
        tr[i].style.display = "";
        noMatch = false;
      }
    }
  
    // Remove existing "no record found" row if present
    var noRecordRow = document.getElementById("noRecordRow");
    if (noRecordRow) {
      noRecordRow.remove();
    }
  
    // If no matches found, add a "no record found" row
    if (noMatch) {
      showNoRecordRow(tbody, table);
    } else {
      removeNoRecordRow(); // Remove the "No record found" row if there are matches
    }
  }
  
  function showNoRecordRow(tbody, table) {
    var noRecordRow = document.querySelector(".no-record-row");
    if (!noRecordRow) {
      var newRow = tbody.insertRow();
      newRow.setAttribute("id", "noRecordRow");
      newRow.setAttribute("class", "no-record-row");
      var cell = newRow.insertCell(0);
      cell.colSpan = table.getElementsByTagName("th").length;
      cell.style.textAlign = "center";
      cell.textContent = "No borrow requests found.";
    } else {
      noRecordRow.style.display = "";
    }
  }
  
  function removeNoRecordRow() {
    var noRecordRow = document.querySelector(".no-record-row");
    if (noRecordRow) {
      noRecordRow.style.display = "none";
    }
  }




// delete button sweetalert
document.addEventListener('DOMContentLoaded', function () {
    document.querySelectorAll('.deleteButton').forEach(function (button) {
        button.addEventListener('click', function () {
            const itemId = this.getAttribute('data-item-id');
            Swal.fire({
                title: 'Are you sure?',
                text: "You won't be able to revert this!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Yes, delete it!'
            }).then((result) => {
                if (result.isConfirmed) {
                    fetch(`/delete-item/${itemId}/`, {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': getCookie('csrftoken'),
                            'Content-Type': 'application/json',
                        },
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            Swal.fire(
                                'Deleted!',
                                'Your item has been deleted.',
                                'success'
                            ).then(() => {
                                location.reload();
                            });
                        } else {
                            Swal.fire(
                                'Error!',
                                'There was a problem deleting your item.',
                                'error'
                            );
                        }
                    });
                }
            });
        });
    });
});


function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}



//toaster message
document.addEventListener("DOMContentLoaded", function() {
    // Configure Toastr options
    toastr.options = {
        "closeButton": true,
        "progressBar": true,
        "timeOut": "5000",
        "positionClass": "toast-bottom-right"
    };

    // Loop through the hidden messages and display them
    document.querySelectorAll('#django-messages .message').forEach(function(el) {
        var messageType = el.getAttribute('data-type');
        var messageContent = el.getAttribute('data-content');

        // Display Toastr notification based on the message type
        if (messageType === 'success') {
            toastr.success(messageContent);
        } else if (messageType === 'error') {
            toastr.error(messageContent);
        } else if (messageType === 'warning') {
            toastr.warning(messageContent);
        } else if (messageType === 'info') {
            toastr.info(messageContent);
        }
    });
});


// Display the notification data
function fetchNotifications() {
    fetch('/get-notifications/')
      .then(response => response.json())
      .then(data => {
        // Update the notification count
        const notificationCount = document.querySelector('.notification-count');
        notificationCount.textContent = data.unread_count;
  
        const notificationCard = document.getElementById('notificationCard');
        notificationCard.innerHTML = '<h4>Notifications</h4>'; // Reset the content
  
        if (data.notifications.length === 0) {
          notificationCard.innerHTML += '<p>No notifications available.</p>';
        } else {
          data.notifications.forEach(notification => {
            const notificationItem = document.createElement('div');
            notificationItem.classList.add('notification-item');
            notificationItem.style.position = 'relative'; // Enable absolute positioning for the icon
  
            notificationItem.innerHTML = `
              <div>
                <i 
                  class="fa-solid fa-trash" 
                  style="position: absolute; top: 5px; right: 5px; cursor: pointer; color: red; font-size: 14px;" 
                  onclick="deleteNotification(${notification.id})">
                </i>
                <p><strong>Student ID:</strong> ${notification.student_id}</p>
                <p><strong>Name:</strong> ${notification.borrower_name}</p>
                <p><strong>Reminder:</strong> ${notification.notification_message}</p>
                <p><strong>Time Span:</strong> ${notification.created_at}</p>
              </div>
            `;
            notificationCard.appendChild(notificationItem);
          });
        }
      })
      .catch(error => console.error('Error fetching notifications:', error));
  }
  
  // Delete notification
  function deleteNotification(notificationId) {
    fetch(`/delete-notificationn/${notificationId}/`, {
      method: 'DELETE',
      headers: {
        'X-CSRFToken': getCsrfToken(), // Ensure CSRF token is sent
      },
    })
      .then(response => {
        if (response.ok) {
          alert('Notification deleted successfully.');
          fetchNotifications(); // Refresh notifications after deletion
        } else {
          alert('Failed to delete notification. Please try again.');
          console.error('Failed to delete notification');
        }
      })
      .catch(error => console.error('Error deleting notification:', error));
  }
  
  // Utility function to fetch CSRF token
  function getCsrfToken() {
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    return csrfToken;
  }
  
  // Fetch notifications when the bell icon is clicked
  function toggleNotifications() {
    const notificationCard = document.getElementById('notificationCard');
    if (notificationCard.style.display === 'block') {
      notificationCard.style.display = 'none';
    } else {
      notificationCard.style.display = 'block';
      fetchNotifications();
  
      // Mark notifications as read
      fetch('/mark-notifications-as-read/', {
        method: 'POST',
        headers: {
          'X-CSRFToken': getCsrfToken(),
        },
      })
        .then(response => response.json())
        .then(data => {
          if (data.status === 'success') {
            const notificationCount = document.querySelector('.notification-count');
            notificationCount.textContent = '0';
          }
        })
        .catch(error => console.error('Error marking notifications as read:', error));
    }
  }
  
  // Fetch notifications once when the page loads
  document.addEventListener('DOMContentLoaded', fetchNotifications);
</script>




{% endblock content %}