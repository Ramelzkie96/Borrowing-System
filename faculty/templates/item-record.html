{% extends "base.html" %}
{% load static %}

{% block extra_css %}
    <link href="{% static 'vendor/pg-calendar/css/pignose.calendar.min.css'%}" rel="stylesheet">
    <link href="{% static 'vendor/chartist/css/chartist.min.css'%}" rel="stylesheet">
    <link href="{% static 'css/style.css'%}" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">
    <style>
        .activee {
            background: #6b51df;
        }
        .intp {
            padding-left: 45px;
            border: 1px solid #828282;
        }
        .intp::placeholder {
            padding-left: -10px;
        }

        .highlight {
            background-color: rgb(0, 255, 13);
        }
    </style>
{% endblock %}


{% block extra_js %}
    <script src="{% static 'vendor/global/global.min.js' %}"></script>
    <script src="{% static 'js/quixnav-init.js' %}"></script>
    <script src="{% static 'js/custom.min.js' %}"></script>
    <script src="{% static 'vendor/moment/moment.min.js'%}"></script>
    <script src="{% static 'js/dashboard/dashboard-2.js'%}"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
{% endblock %}



{% block content %}
    <!--*******************
        Preloader start
    ********************-->
    <div id="preloader">
        <div class="sk-three-bounce">
            <div class="sk-child sk-bounce1"></div>
            <div class="sk-child sk-bounce2"></div>
            <div class="sk-child sk-bounce3"></div>
        </div>
    </div>
    <!--*******************
        Preloader end
    ********************-->


    <!--**********************************
        Main wrapper start
    ***********************************-->
    <div id="main-wrapper">

        <!--**********************************
            Nav header start
        ***********************************-->
        <div class="nav-header">
            <a href="index.html" class="brand-logo">
                <img class="logo-abbr" src="{% static 'images/pit_logo.png'%}" alt="">
                <img class="brand-title" src="{% static 'images/faculty.png'%}" alt="">
            </a>

            <div class="nav-control">
                <div class="hamburger">
                    <span class="line"></span><span class="line"></span><span class="line"></span>
                </div>
            </div>
        </div>
        <!--**********************************
            Nav header end
        ***********************************-->

        <!--**********************************
            Header start
        ***********************************-->
        <div class="header">
            <div class="header-content">
                <nav class="navbar navbar-expand">
                    <div class="collapse navbar-collapse justify-content-between">
                        <div class="header-left">

                        </div>

                        <ul class="navbar-nav header-right">

                            <li class="nav-item dropdown header-profile">
                                <a class="nav-link" href="#" role="button" data-toggle="dropdown">
                                    <a class="nav-link" href="#" role="button" data-toggle="dropdown">
                                        {% if request.user.profile_picture %}
                                            <img src="{{ request.user.profile_picture.url }}" alt="{{ request.user.username }}'s profile picture">
                                        {% else %}
                                        <img src="{% static 'images/users.jpg' %}" alt="Default profile picture">
                                        {% endif %}
                                    </a>
                                    <span class="text-dark">{{ request.user.username }}</span>
                                </a>
                                <div class="dropdown-menu dropdown-menu-right">
                                    <a href="./app-profile.html" class="dropdown-item">
                                        <i class="icon-user"></i>
                                        <span class="ml-2">Profile </span>
                                    </a>
                                    <a href="./email-inbox.html" class="dropdown-item">
                                        <i class="icon-envelope-open"></i>
                                        <span class="ml-2">Inbox </span>
                                    </a>
                                    <a href="./page-login.html" class="dropdown-item">
                                        <i class="icon-key"></i>
                                        <span class="ml-2">Logout </span>
                                    </a>
                                </div>
                            </li>
                        </ul>
                    </div>
                </nav>
            </div>
        </div>
        <!--**********************************
            Header end ti-comment-alt
        ***********************************-->

        <!--**********************************
            Sidebar start
        ***********************************-->
        <div class="quixnav">
            <div class="quixnav-scroll">
                <ul class="metismenu" id="menu">
                    <li class="nav-label first">Main Menu</li>
                    <!-- <li><a href="index.html"><i class="icon icon-single-04"></i><span class="nav-text">Dashboard</span></a>
                    </li> -->
                    <li><a  href="{% url 'dashboard'%}" aria-expanded="false">
                        <img src="{% static 'images/dashboard.png'%}" width="30" height="30" alt="">
                        <span class="nav-text" style="color: white;">Dashboard</span></a>

                    </li>

                    <li class="nav-label">ITEMS</li>
                    <li><a class="has-arrow" href="javascript:void()" aria-expanded="false">
                        <img src="{% static 'images/item.png'%}" width="30" height="30" alt="">
                        <span class="nav-text" >Manage Items</span></a>
                        <ul aria-expanded="false">
                            <li><a href="{%url 'add-item'%}">Add Item</a></li>
                            <li><a href="{% url 'item-record'%}" style="color: white;">Item Records</a></li>
                        </ul>
                    </li>
                    <li><a href="{% url 'borrowers'%}" aria-expanded="false">
                        <img src="{% static 'images/add-item.png'%}" width="30" height="30" alt="">
                        <span class="nav-text">Add Borrow Item</span></a>
                    </li>
                    <li><a href="{% url 'borrow-record'%}" aria-expanded="false">
                        <img src="{% static 'images/search.png'%}" width="30" height="30" alt="">
                        <span class="nav-text">Borrow Record</span></a>
                    </li>

                    <li class="nav-label">Borrower's Reservation</li>
                    <li><a  href="{% url 'student-reservation' %}" aria-expanded="false">
                        <img src="{% static 'images/reservation.png'%}" width="30" height="30" alt="">
                        <span class="nav-text">Reservation List</span></a>
                    </li>

                    <li class="nav-label">ACCOUNTS</li>
                    <li><a class="has-arrow" href="javascript:void()" aria-expanded="false">
                        <img src="{% static 'images/userr.png'%}" width="30" height="30" alt="">
                        <span class="nav-text">User</span></a>
                        <ul aria-expanded="false">
                            <li><a href="{% url 'change-profile' %}">Change Profile</a></li>
                            <li><a href="{% url 'change-password' %}">Change Password</a></li>
                        </ul>
                    </li>
                    <li><a href="{% url 'logout'%}" aria-expanded="false">
                        <img src="{% static 'images/logout.png'%}" width="30" height="30" alt="">
                        <span class="nav-text">Logout</span></a>
                    </li>
                </ul>
            </div>
        </div>
        <!--**********************************
            Sidebar end
        ***********************************-->

        <!--**********************************
            Content body start
        ***********************************-->

        <!-- Modal for Editing Item -->
    <div class="modal fade" id="exampleModalCenter">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" style="font-size: 25px; font-weight: 700;">Edit Item</h5>
                    <button type="button" class="close" data-dismiss="modal"><span>&times;</span></button>
                </div>
                <div class="modal-body">
                    <form method="POST" action="{% url 'update_item' %}" id="edit-item-form">
                        {% csrf_token %}
                        <input type="hidden" name="item_id" value="">

                        <div class="form-group row mb-4">
                            <label class="col-form-label text-md-right col-12 col-md-3 col-lg-3 text-dark" style="font-size: 15px">Property ID</label>
                            <div class="col-sm-12 col-md-7">
                                <input type="text" name="property_id" style="border: 1px solid #bebebe;" class="form-control">
                            </div>
                        </div>

                        <div class="form-group row mb-4">
                            <label class="col-form-label text-md-right col-12 col-md-3 col-lg-3 text-dark" style="font-size: 15px">Name</label>
                            <div class="col-sm-12 col-md-7">
                                <input type="text" name="name" style="border: 1px solid #bebebe;" class="form-control" id="item-name" required>
                                <div id="name-validation-error" class="text-danger" style="display: none;">This item name already exists.</div>
                            </div>
                        </div>

                        <div class="form-group row mb-4">
                            <label class="col-form-label text-md-right col-12 col-md-3 col-lg-3 text-dark" style="font-size: 15px">Quantity</label>
                            <div class="col-sm-12 col-md-7">
                                <input type="number" style="width: 100px; border: 1px solid #bebebe;" class="form-control" name="quantity" min="1" max="100" required>
                            </div>
                        </div>

                        <div class="form-group row mb-4">
                            <label class="col-form-label text-md-right col-12 col-md-3 col-lg-3"></label>
                            <div class="col-sm-12 col-md-7">
                                <button class="btn btn-primary" type="submit" id="submit-button">Update</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
      </div>


        <div class="content-body">

            <!-- Dynamic messages start -->
            <div id="django-messages" style="display:none;">
                {% for message in messages %}
                    <div class="message" data-type="{{ message.tags }}" data-content="{{ message|escapejs }}"></div>
                {% endfor %}
            </div>
            <!-- Dynamic messages end -->

            <div class="container-fluid">
                <div class="row">
                    <div class="col-lg-12">
                        <div class="card" style="border-top: 4px solid #593bdb; box-shadow: rgba(0, 0, 0, 0.18) 0px 2px 4px;">
                            <div class="card-header">
                                <h4 class="card-title" style="font-size: 25px;color: #593bdb;">All Item</h4>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <div style="display: flex; justify-content: space-between;">
                                        <a href="{% url 'add-item' %}" class="btn btn-whatsapp mb-3" style="box-shadow: rgba(0, 0, 0, 0.24) 0px 3px 8px;">Add New Item <span class="btn-icon-right"><img src="{% static 'images/plus.png' %}" alt="" width="30" height="30"></span></a>
                                        <div class="sea">
                                            <i class='bx bx-search-alt-2' style="color: #593bdb; position: absolute; font-size: 20px; right: 200px; top: 83px;"></i>
                                            <input type="search" id="searchInput" placeholder="Search" class="form-control intp" onkeyup="searchTable()">
                                        </div>
                                    </div>
                                    <div class="dataTables_length" id="example_length" style="color: #333; width: 140px;">
                                        <label>Show entries
                                            <select name="example_length" aria-controls="example" class="form-control" onchange="updateShowEntries(this.value)">
                                                <option value="all" {% if current_show == 'all' %}selected{% endif %}>All</option>
                                                <option value="5" {% if current_show == 5 %}selected{% endif %}>5</option>
                                                <option value="10" {% if current_show == 10 %}selected{% endif %}>10</option>
                                                <option value="25" {% if current_show == 25 %}selected{% endif %}>25</option>
                                                <option value="50" {% if current_show == 50 %}selected{% endif %}>50</option>
                                                <option value="100" {% if current_show == 100 %}selected{% endif %}>100</option>
                                            </select>
                                        </label>
                                    </div>

                                    <table id="itemTable" class="table table-bordered table-striped table-responsive-sm" style="color: #333;">
                                        <thead class="thead-primary">
                                            <tr>
                                                <th>Property ID</th>  <!-- Change ID to # for numbering -->
                                                <th>Item</th>
                                                <th>Quantity</th>
                                                <th style="width: 150px;">Action</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% if page_obj %}
                                                {% for item in page_obj %}
                                                    <tr>
                                                        <td>{{ item.property_id }}</td>  <!-- Display the loop index starting from 1 -->
                                                        <td>{{ item.name }}</td>
                                                        <td>{{ item.quantity }}</td>
                                                        <td>
                                                            <button type="button" class="btn btn-secondary edit-item-btn"
                                                                data-id="{{ item.id }}"
                                                                data-name="{{ item.name }}"
                                                                date-property-id="{{ item.property_id }}"
                                                                data-quantity="{{ item.quantity }}"
                                                                data-toggle="modal"
                                                                data-target="#exampleModalCenter">
                                                                <i class="fas fa-edit"></i>
                                                            </button>
                                                            <button class="btn btn-danger btn deleteButton" data-item-id="{{ item.id }}"><i class="fas fa-trash"></i></button>
                                                        </td>
                                                    </tr>
                                                {% endfor %}
                                            {% else %}
                                                <tr>
                                                    <td colspan="5" class="text-center">No Record Available</td>
                                                </tr>
                                            {% endif %}
                                        </tbody>
                                    </table>


                                    <nav>
                                        <ul class="pagination pagination-gutter">
                                            {% if page_obj.has_previous %}
                                                <li class="page-item page-indicator">
                                                    <a class="page-link" href="?page={{ page_obj.previous_page_number }}&show={{ current_show }}">
                                                        <i class="icon-arrow-left"></i>
                                                    </a>
                                                </li>
                                            {% else %}
                                                <li class="page-item page-indicator disabled">
                                                    <a class="page-link" href="javascript:void(0)">
                                                        <i class="icon-arrow-left"></i>
                                                    </a>
                                                </li>
                                            {% endif %}
                                            {% for num in page_obj.paginator.page_range %}
                                                {% if page_obj.number == num %}
                                                    <li class="page-item active">
                                                        <a class="page-link" href="javascript:void(0)">{{ num }}</a>
                                                    </li>
                                                {% else %}
                                                    <li class="page-item">
                                                        <a class="page-link" href="?page={{ num }}&show={{ current_show }}">{{ num }}</a>
                                                    </li>
                                                {% endif %}
                                            {% endfor %}
                                            {% if page_obj.has_next %}
                                                <li class="page-item page-indicator">
                                                    <a class="page-link" href="?page={{ page_obj.next_page_number }}&show={{ current_show }}">
                                                        <i class="icon-arrow-right"></i>
                                                    </a>
                                                </li>
                                            {% else %}
                                                <li class="page-item page-indicator disabled">
                                                    <a class="page-link" href="javascript:void(0)">
                                                        <i class="icon-arrow-right"></i>
                                                    </a>
                                                </li>
                                            {% endif %}
                                        </ul>
                                    </nav>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
        <!--**********************************
            Content body end
        ***********************************-->


        <!--**********************************
            Footer start
        ***********************************-->
        <div class="footer">
            <div class="copyright">
                <p>Copyright © Designed &amp; Developed by <a href="#" target="_blank">Quixkit</a> 2019</p>
                <p>Distributed by <a href="https://themewagon.com/" target="_blank">Themewagon</a></p>
            </div>
        </div>
    </div>


    <script>
            //edit
    document.addEventListener('DOMContentLoaded', function() {
        var editButtons = document.querySelectorAll('.edit-item-btn');

        editButtons.forEach(function(button) {
            button.addEventListener('click', function() {
                var itemId = this.getAttribute('data-id');
                var itemName = this.getAttribute('data-name');
                var itemQuantity = this.getAttribute('data-quantity');
                var propertyId = this.getAttribute('date-property-id');

                // Set the modal input values
                document.querySelector('#exampleModalCenter input[name="item_id"]').value = itemId;
                document.querySelector('#exampleModalCenter input[name="name"]').value = itemName;
                document.querySelector('#exampleModalCenter input[name="quantity"]').value = itemQuantity;
                document.querySelector('#exampleModalCenter input[name="property_id"]').value = propertyId;
            });
        });
    });


    document.getElementById('item-name').addEventListener('input', function () {
      const nameField = this;
      const errorDiv = document.getElementById('name-validation-error');
      const submitButton = document.getElementById('submit-button');
      const nameValue = nameField.value;

      if (nameValue.trim().length > 0) {
          fetch(`/admin-validate-item-name/?name=${encodeURIComponent(nameValue)}`)
              .then(response => response.json())
              .then(data => {
                  if (data.exists) {
                      errorDiv.style.display = 'block';
                      submitButton.disabled = true; // Disable the button if item name exists
                  } else {
                      errorDiv.style.display = 'none';
                      submitButton.disabled = false; // Enable the button if item name does not exist
                  }
              })
              .catch(error => {
                  console.error('Error:', error);
                  submitButton.disabled = false; // Enable the button if there's an error in the request
              });
      } else {
          errorDiv.style.display = 'none';
          submitButton.disabled = false; // Enable the button if the input is cleared
      }
  });

        function updateShowEntries(value) {
    const urlParams = new URLSearchParams(window.location.search);
    urlParams.set('show', value);
    window.location.search = urlParams.toString();
}




document.getElementById("searchInput").addEventListener("input", function () {
    searchTable();
});

function searchTable() {
    var input, filter, table, tbody, tr, td, i, j, txtValue, regex;
    input = document.getElementById("searchInput");
    filter = input.value.toUpperCase();
    regex = new RegExp(`(${filter})`, 'gi');
    table = document.getElementById("itemTable");
    tbody = table.getElementsByTagName("tbody")[0];
    tr = tbody.getElementsByTagName("tr");
    var noMatch = true;

    // If input is empty, reset table to show all rows and remove the "No record found" row
    if (!filter) {
        for (i = 0; i < tr.length; i++) {
            tr[i].style.display = ""; // Show all rows
            td = tr[i].getElementsByTagName("td");
            for (j = 0; j < td.length; j++) {
                if (j === 4) { // Skip the action column
                    continue;
                }
                td[j].innerHTML = td[j].textContent || td[j].innerText; // Reset content to normal text
            }
        }
        removeNoRecordRow(); // Remove "No record found" row if it exists
        return;
    }

    // If there's input, filter the table rows
    for (i = 0; i < tr.length; i++) {
        tr[i].style.display = "none"; // Hide all rows initially
        td = tr[i].getElementsByTagName("td");
        let rowContainsFilter = false;

        for (j = 0; j < td.length; j++) {
            if (j === 4) { // Skip the action column
                continue;
            }
            if (td[j]) {
                txtValue = td[j].textContent || td[j].innerText;
                if (txtValue.toUpperCase().indexOf(filter) > -1) {
                    rowContainsFilter = true;
                    // Highlight matched text
                    td[j].innerHTML = txtValue.replace(regex, "<span style='background-color: rgb(0, 255, 13);'>$1</span>");
                } else {
                    // Remove highlight if no match
                    td[j].innerHTML = txtValue.replace(/<span style='background-color: rgb\(0, 255, 13\);'>(.*?)<\/span>/g, "$1");
                }
            }
        }

        if (rowContainsFilter) {
            tr[i].style.display = ""; // Show the row if it matches the filter
            noMatch = false;
        }
    }

    // Show or hide "No record found" message
    if (noMatch) {
        showNoRecordRow();
    } else {
        removeNoRecordRow();
    }
}

function showNoRecordRow() {
    var noRecordRow = document.querySelector(".no-record-row");
    if (!noRecordRow) {
        var tbody = document.querySelector("#itemTable tbody");
        var newRow = tbody.insertRow();
        newRow.classList.add("no-record-row");
        var cell = newRow.insertCell(0);
        cell.colSpan = 5; // Adjust this to span across all columns, including the action column
        cell.style.textAlign = "center";
        cell.textContent = "No record found.";
    }
}

function removeNoRecordRow() {
    var noRecordRow = document.querySelector(".no-record-row");
    if (noRecordRow) {
        noRecordRow.remove();
    }
}





// delete button sweetalert
document.addEventListener('DOMContentLoaded', function () {
    document.querySelectorAll('.deleteButton').forEach(function (button) {
        button.addEventListener('click', function () {
            const itemId = this.getAttribute('data-item-id');
            Swal.fire({
                title: 'Are you sure?',
                text: "You won't be able to revert this!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Yes, delete it!'
            }).then((result) => {
                if (result.isConfirmed) {
                    fetch(`/delete-item/${itemId}/`, {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': getCookie('csrftoken'),
                            'Content-Type': 'application/json',
                        },
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            Swal.fire(
                                'Deleted!',
                                'Your item has been deleted.',
                                'success'
                            ).then(() => {
                                location.reload();
                            });
                        } else {
                            Swal.fire(
                                'Error!',
                                'There was a problem deleting your item.',
                                'error'
                            );
                        }
                    });
                }
            });
        });
    });
});


function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}



//toaster message
document.addEventListener("DOMContentLoaded", function() {
    // Configure Toastr options
    toastr.options = {
        "closeButton": true,
        "progressBar": true,
        "timeOut": "5000",
        "positionClass": "toast-bottom-right"
    };

    // Loop through the hidden messages and display them
    document.querySelectorAll('#django-messages .message').forEach(function(el) {
        var messageType = el.getAttribute('data-type');
        var messageContent = el.getAttribute('data-content');

        // Display Toastr notification based on the message type
        if (messageType === 'success') {
            toastr.success(messageContent);
        } else if (messageType === 'error') {
            toastr.error(messageContent);
        } else if (messageType === 'warning') {
            toastr.warning(messageContent);
        } else if (messageType === 'info') {
            toastr.info(messageContent);
        }
    });
});
</script>




{% endblock content %}